@model praca_dyplomowa_zesp.Models.Modules.Games.GameBrowserViewModel
@{
    ViewData["Title"] = Model.Mode == "guides" ? "Baza Poradników" : "Przeglądaj Gry";
}

<style>
    /* --- LOKALNE STYLE DLA PRZEGLĄDARKI GIER --- */

    .browse-title {
        text-transform: uppercase;
        font-weight: 900;
        letter-spacing: 2px;
        background: linear-gradient(90deg, #ffffff 0%, var(--light-pink) 30%, var(--mid-pink) 60%, var(--deep-purple) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 25px rgba(255, 102, 196, 0.4);
        margin-bottom: 0.5rem;
    }

    .browse-subtitle {
        color: #aaa;
        font-weight: 300;
        letter-spacing: 0.5px;
    }

    /* --- PANEL FILTRÓW --- */
    .filter-panel {
        background: rgba(26, 26, 32, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .search-input {
        background-color: rgba(0, 0, 0, 0.3) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: #fff !important;
        border-radius: 30px 0 0 30px !important;
        padding-left: 20px;
    }

        .search-input:focus {
            border-color: var(--mid-pink) !important;
            box-shadow: 0 0 10px rgba(255, 102, 196, 0.2) !important;
        }

    .search-btn {
        border-radius: 0 30px 30px 0 !important;
        background: linear-gradient(45deg, var(--deep-purple), var(--mid-pink));
        border: none;
        padding: 0 25px;
        color: white;
        font-weight: bold;
        transition: filter 0.3s;
    }

        .search-btn:hover {
            filter: brightness(1.2);
        }

    /* --- SUWAKI (SWITCHES) - POPRAWIONE WYMIARY --- */
    .form-check-input {
        background-color: #2a2a30;
        border-color: #555;
        /* ZMNIEJSZONE WYMIARY: */
        width: 2.2em; /* Było 3em */
        height: 1.1em; /* Było 1.5em */

        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 0.2em; /* Drobna korekta pionowa */
    }

        .form-check-input:checked {
            border: none;
            transform: scale(1.1); /* Lekkie powiększenie przy włączeniu */
        }

    #checkCritic:checked {
        background-color: #00f3ff;
        box-shadow: 0 0 12px #00f3ff;
    }

    #checkUser:checked {
        background-color: #ffc107;
        box-shadow: 0 0 12px #ffc107;
    }

    #checkLocal:checked {
        background-color: #bc13fe;
        box-shadow: 0 0 12px #bc13fe;
    }

    .label-critic {
        color: #00f3ff;
        text-shadow: 0 0 5px rgba(0, 243, 255, 0.5);
        cursor: pointer;
        font-size: 0.9rem;
    }

    .label-user {
        color: #ffc107;
        text-shadow: 0 0 5px rgba(255, 193, 7, 0.5);
        cursor: pointer;
        font-size: 0.9rem;
    }

    .label-local {
        color: #bc13fe;
        text-shadow: 0 0 5px rgba(188, 19, 254, 0.5);
        cursor: pointer;
        font-size: 0.9rem;
    }

    /* --- KARTY GIER --- */
    .game-card {
        background-color: #1a1a20;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.05);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        position: relative;
        height: 100%;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .game-card-wrapper:hover .game-card {
        transform: translateY(-8px) scale(1.02);
        border-color: var(--mid-pink);
        box-shadow: 0 0 25px rgba(255, 102, 196, 0.3);
        z-index: 10;
    }

    .cover-container {
        position: relative;
        padding-top: 140%;
        overflow: hidden;
        background-color: #0b0b0e;
    }

    .cover-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s;
    }

    .game-card-wrapper:hover .cover-img {
        transform: scale(1.1);
    }

    .game-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: #fff;
        margin-top: 10px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: color 0.3s;
    }

    /* Tytuł na różowo przy hoverze */
    .game-card-wrapper:hover .game-title {
        color: var(--mid-pink);
        text-shadow: 0 0 5px rgba(255, 102, 196, 0.5);
    }

    .rating-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        font-weight: 800;
        font-size: 0.85rem;
        padding: 4px 8px;
        border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.8);
        backdrop-filter: blur(4px);
    }

    .rating-high {
        background-color: rgba(0, 255, 157, 0.9);
        color: #000;
        box-shadow: 0 0 10px rgba(0, 255, 157, 0.4);
    }

    .rating-mid {
        background-color: rgba(255, 193, 7, 0.9);
        color: #000;
        box-shadow: 0 0 10px rgba(255, 193, 7, 0.4);
    }

    .rating-low {
        background-color: rgba(255, 51, 102, 0.9);
        color: #fff;
        box-shadow: 0 0 10px rgba(255, 51, 102, 0.4);
    }

    /* PAGINACJA */
    .pagination .page-link {
        background-color: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ccc;
        margin: 0 5px;
        border-radius: 5px;
    }

        .pagination .page-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

    .pagination .page-item.active .page-link {
        background: linear-gradient(45deg, var(--deep-purple), var(--mid-pink));
        border-color: transparent;
        color: #fff;
        box-shadow: 0 0 15px rgba(188, 19, 254, 0.4);
    }

    .pagination .page-item.disabled .page-link {
        background-color: transparent;
        border-color: rgba(255,255,255,0.05);
        color: #555;
    }
</style>

<div class="container-fluid px-4 pt-3">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="browse-title">@ViewData["Title"]</h1>
            @if (Model.Mode == "guides")
            {
                <p class="browse-subtitle">Wybierz grę, aby znaleźć pomoc lub podzielić się wiedzą.</p>
            }
        </div>
    </div>

    @* --- PANEL FILTRÓW I WYSZUKIWANIA --- *@
    <div class="filter-panel">
        <form asp-action="Index" method="get" class="row g-3 align-items-center justify-content-center">
            <input type="hidden" name="mode" value="@Model.Mode" />

            <div class="@(Model.Mode == "guides" ? "col-md-8" : "col-md-5")">
                <div class="input-group">
                    <input type="text" name="searchString" class="form-control search-input"
                           placeholder="@(Model.Mode == "guides" ? "Wpisz tytuł gry..." : "Szukaj gry w bazie...")"
                           value="@Model.SearchString" />
                    <button type="submit" class="btn search-btn"><i class="fas fa-search"></i></button>
                </div>
            </div>

            @if (Model.Mode == "browse")
            {
                <input type="hidden" name="isFiltered" value="true" />

                <div class="col-md-7">
                    <div class="d-flex gap-4 justify-content-md-end align-items-center flex-wrap">
                        <span class="text-white small text-uppercase fw-bold" style="opacity: 0.7; letter-spacing: 1px;">Źródło oceny:</span>

                        @* 1. KRYTYCY *@
                        <div class="form-check form-switch d-flex align-items-center gap-2">
                            <input class="form-check-input" type="checkbox" id="checkCritic" name="showCritic" value="true" @(Model.ShowIgdbCritic ? "checked" : "") onchange="this.form.submit()">
                            <label class="form-check-label label-critic fw-bold" for="checkCritic">Krytycy</label>
                        </div>

                        @* 2. GRACZE *@
                        <div class="form-check form-switch d-flex align-items-center gap-2">
                            <input class="form-check-input" type="checkbox" id="checkUser" name="showUser" value="true" @(Model.ShowIgdbUser ? "checked" : "") onchange="this.form.submit()">
                            <label class="form-check-label label-user fw-bold" for="checkUser">Gracze</label>
                        </div>

                        @* 3. GAMEHUB *@
                        <div class="form-check form-switch d-flex align-items-center gap-2">
                            <input class="form-check-input" type="checkbox" id="checkLocal" name="showLocal" value="true" @(Model.ShowLocal ? "checked" : "") onchange="this.form.submit()">
                            <label class="form-check-label label-local fw-bold" for="checkLocal">GameHub</label>
                        </div>
                    </div>
                </div>
            }

            <input type="hidden" name="page" value="1" />
        </form>
    </div>

    @* --- LISTA GIER --- *@
    <div class="row g-4">
        @if (Model.Games.Any())
        {
            @foreach (var game in Model.Games)
            {
                <div class="col-6 col-md-3 col-xl-2">
                    <a asp-controller="@(Model.Mode == "guides" ? "Guides" : "Games")"
                       asp-action="@(Model.Mode == "guides" ? "Index" : "Details")"
                       asp-route-gameId="@(Model.Mode == "guides" ? game.Id : null)"
                       asp-route-id="@(Model.Mode != "guides" ? game.Id : null)"
                       class="text-decoration-none game-card-wrapper d-block h-100">

                        @RenderGameCard(game)
                    </a>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="filter-panel text-center py-5">
                    <i class="fas fa-ghost fa-3x mb-3" style="color: var(--mid-pink); opacity: 0.5;"></i>
                    <h4 class="text-white">Nic nie znaleziono</h4>
                    <p class="text-muted">Spróbuj zmienić filtry lub wpisać inną nazwę.</p>
                </div>
            </div>
        }
    </div>

    @* --- PAGINACJA --- *@
    <div class="mt-5 mb-4">
        <nav aria-label="Paginacja">
            <ul class="pagination justify-content-center">
                @{
                    var prevDisabled = Model.CurrentPage > 1 ? "" : "disabled";
                    var nextDisabled = Model.Games.Count == 60 ? "" : "disabled";

                    string GetPageUrl(int pageNum) => Url.Action("Index", new
                    {
                        page = pageNum,
                        searchString = Model.SearchString,
                        mode = Model.Mode,
                        isFiltered = true,
                        showUser = Model.ShowIgdbUser,
                        showCritic = Model.ShowIgdbCritic,
                        showLocal = Model.ShowLocal
                    });
                }

                <li class="page-item @prevDisabled">
                    <a class="page-link" href="@GetPageUrl(Model.CurrentPage - 1)">
                        <i class="fas fa-chevron-left me-1"></i> Poprzednia
                    </a>
                </li>

                <li class="page-item active">
                    <span class="page-link">@Model.CurrentPage</span>
                </li>

                <li class="page-item @nextDisabled">
                    <a class="page-link" href="@GetPageUrl(Model.CurrentPage + 1)">
                        Następna <i class="fas fa-chevron-right ms-1"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>

@{
    Microsoft.AspNetCore.Html.IHtmlContent RenderGameCard(dynamic game)
    {
        <div class="game-card">
            <div class="cover-container">
                <img src="@(game.Cover?.Url ?? "https://via.placeholder.com/264x352.png?text=Brak+Okładki")"
                     class="cover-img"
                     alt="@game.Name">

                @if (Model.Mode != "guides" && game.Total_rating != null && game.Total_rating > 0)
                {
                    double rating = (double)game.Total_rating;
                    string badgeClass = rating >= 75 ? "rating-high" : (rating >= 50 ? "rating-mid" : "rating-low");

                    <div class="rating-badge @badgeClass">
                        @rating.ToString("0")
                    </div>
                }
            </div>

            <div class="p-3">
                <div class="game-title" title="@game.Name">
                    @game.Name
                </div>
            </div>
        </div>
        return Html.Raw("");
    }
}