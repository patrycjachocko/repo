@model GameInLibraryViewModel

@{
    ViewData["Title"] = Model.Name;
}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        $('.achievement-checkbox').change(function () {
            var gameId = @Model.IgdbGameId;
            var achievementId = $(this).data('external-id');
            var isChecked = $(this).is(':checked');

            $.ajax({
                url: '@Url.Action("ToggleAchievement", "Library")',
                type: 'POST',
                data: {
                    igdbGameId: gameId,
                    achievementExternalId: achievementId
                },
                headers: {
                    // Dla ochrony przed CSRF
                    RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (!response.success) {
                        alert(response.error || 'Wystąpił błąd');
                        $(this).prop('checked', !isChecked); // Cofnij zmianę
                    }
                },
                error: function () {
                    alert('Błąd komunikacji z serwerem.');
                    $(this).prop('checked', !isChecked); // Cofnij zmianę
                }
            });
        });
    });
</script>


<div class="row">
    <div class="col-md-4">
        <img src="@(Model.CoverUrl ?? "https://via.placeholder.com/264x352.png?text=Brak+okładki")" class="img-fluid rounded mb-3" alt="Okładka @Model.Name">

        <h4>Postęp Fabularny</h4>
        <form asp-action="Edit" asp-route-id="@Model.DbId">

            <input type="hidden" name="Id" value="@Model.DbId" />
            <input type="hidden" name="IgdbGameId" value="@Model.IgdbGameId" />
            <input type="hidden" name="UserId" value="@Model.UserId" />
            <input type="hidden" name="DateAddedToLibrary" value="@Model.DateAddedToLibrary" />

            <div class="mb-3">
                <label asp-for="CurrentUserStoryMission" class="form-label">Obecna misja:</label>
                <input asp-for="CurrentUserStoryMission" class="form-control" />
            </div>
            <div class="mb-3">
                <label asp-for="CurrentUserStoryProgressPercent" class="form-label">Postęp (%):</label>
                <input asp-for="CurrentUserStoryProgressPercent" type="number" min="0" max="100" class="form-control" />
                <div class="progress mt-2" style="height: 20px;">
                    <div class="progress-bar" role="progressbar" style="width: @Model.CurrentUserStoryProgressPercent%;" aria-valuenow="@Model.CurrentUserStoryProgressPercent" aria-valuemin="0" aria-valuemax="100">@Model.CurrentUserStoryProgressPercent%</div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Zapisz postęp</button>
        </form>

    </div>

    <div class="col-md-8">
        <h1>@Model.Name</h1>
        <hr />

        <div class="mb-3">
            <a asp-controller="Guides" asp-action="Index" asp-route-gameId="@Model.IgdbGameId" class="btn btn-outline-info">
                Przejdź do Poradników i Wskazówek
            </a>
            <a asp-action="Edit" asp-route-id="@Model.DbId" class="btn btn-secondary">Edytuj Postęp</a>
            <a asp-action="Delete" asp-route-id="@Model.DbId" class="btn btn-danger">Usuń z biblioteki</a>
        </div>


        <dl class="row">
            <dt class="col-sm-3">Deweloper</dt>
            <dd class="col-sm-9">@(Model.Developer ?? "Nieznany")</dd>

            <dt class="col-sm-3">Data wydania</dt>
            <dd class="col-sm-9">@(Model.ReleaseDate ?? "Nieznana")</dd>

            <dt class="col-sm-3">Data dodania</dt>
            <dd class="col-sm-9">@Model.DateAddedToLibrary.ToString("dd.MM.yyyy")</dd>

            <dt class="col-sm-3">Gatunki</dt>
            <dd class="col-sm-9">
                @if (Model.Genres != null && Model.Genres.Any())
                {
                    @string.Join(", ", Model.Genres)
                }
                else
                {
                    <span>Nieznane</span>
                }
            </dd>
        </dl>

        <hr />

        <h3>Osiągnięcia</h3>
        @if (Model.Achievements != null && Model.Achievements.Any())
        {
            <form>
                @Html.AntiForgeryToken() <ul class="list-group">
                    @foreach (var ach in Model.Achievements)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <img src="@ach.IconUrl" alt="Ikona" style="width: 64px; height: 64px; margin-right: 15px;" class="rounded">
                                <div>
                                    <strong>@ach.Name</strong>
                                    <p class="mb-0 text-muted" style="font-size: 0.9rem;">@ach.Description</p>
                                </div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input achievement-checkbox"
                                       type="checkbox"
                                       role="switch"
                                       id="ach-@ach.ExternalId"
                                       data-external-id="@ach.ExternalId"
                                @(ach.IsUnlocked ? "checked" : "")>
                                <label class="form-check-label" for="ach-@ach.ExternalId">
                                    @(ach.IsUnlocked ? "Odblokowane" : "Zablokowane")
                                </label>
                            </div>
                        </li>
                    }
                </ul>
            </form>
        }
        else
        {
            <p>Brak dostępnych osiągnięć do śledzenia dla tej gry.</p>
        }
    </div>
</div>