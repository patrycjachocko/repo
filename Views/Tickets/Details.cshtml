@model praca_dyplomowa_zesp.Models.Ticket
@using Microsoft.AspNetCore.Identity
@using praca_dyplomowa_zesp.Models.Users
@inject UserManager<User> UserManager

@{
    ViewData["Title"] = "Szczegóły zgłoszenia";
    var currentUser = await UserManager.GetUserAsync(User);

    string GetAvatarBase64(User u)
    {
        if (u?.ProfilePicture != null && u.ProfilePicture.Length > 0)
        {
            var base64 = Convert.ToBase64String(u.ProfilePicture);
            var type = u.ProfilePictureContentType ?? "image/jpeg";
            return $"data:{type};base64,{base64}";
        }
        return "/img/default-avatar.png";
    }

    string currentUserAvatar = GetAvatarBase64(currentUser);
}

@* --- KONTENER NA POWIADOMIENIA (ŚRODEK EKRANU) --- *@
@* ZMIANA: top-50 start-50 translate-middle centruje element *@
<div id="toast-container" class="position-fixed top-50 start-50 translate-middle p-3" style="z-index: 9999; min-width: 450px;"></div>

<div class="container mt-4 mb-5 main-container fade-in-up">

    @* --- PASEK NAWIGACYJNY --- *@
    <div class="mb-4 d-flex justify-content-between align-items-center">
        <a asp-action="Index" class="btn btn-ghost-cancel border border-secondary px-3 btn-sm">
            <i class="fas fa-arrow-left me-2"></i> WRÓĆ DO LISTY
        </a>
    </div>

    @* --- GŁÓWNY KONTENER CZATU --- *@
    <div class="ticket-chat-wrapper"
         style="height: 75vh;
                background-color: var(--bg-panel);
                border: 1px solid var(--neon-purple);
                box-shadow: 0 0 25px rgba(189, 0, 255, 0.15);">

        @* --- HEADER --- *@
        <div class="chat-header-bar">
            <div>
                <div class="d-flex align-items-center gap-2 mb-1">
                    <i class="fas fa-ticket-alt text-neon-cyan"></i>
                    <small class="text-muted text-uppercase fw-bold" style="letter-spacing: 1px;">Ticket #@Model.Id</small>
                </div>
                <h5 class="text-white mb-0 fw-bold">@Model.Title</h5>
            </div>
            <div>
                @{
                    string statusClass = "status-badge-grey";
                    string statusLabel = "ZAMKNIĘTE";

                    if (Model.Status == praca_dyplomowa_zesp.Models.TicketStatus.Oczekujące)
                    {
                        statusClass = "status-badge-light text-neon-green border-success";
                        statusLabel = "OCZEKUJĄCE";
                    }
                    else if (Model.Status == praca_dyplomowa_zesp.Models.TicketStatus.W_trakcie)
                    {
                        statusClass = "status-badge-yellow";
                        statusLabel = "W TRAKCIE";
                    }
                }
                <span class="status-badge @statusClass">@statusLabel</span>
            </div>
        </div>

        @* --- OBSZAR WIADOMOŚCI --- *@
        <div class="chat-messages-area" id="chatBox">

            <div class="msg-row msg-right msg-role-User">
                <div class="msg-bubble">
                    <div class="msg-meta text-end">Ty • @Model.CreatedAt.ToString("dd.MM HH:mm")</div>
                    <div class="msg-content">@Model.Content</div>
                </div>
                <img src="@currentUserAvatar" class="msg-avatar" style="border-color: var(--neon-cyan);">
            </div>

            @foreach (var msg in Model.Messages.OrderBy(m => m.CreatedAt))
            {
                bool isMe = msg.UserId == currentUser.Id;
                string userRole = msg.User?.Role ?? "User";
                string roleClass = $"msg-role-{userRole}";
                string alignmentClass = isMe ? "msg-right" : "msg-left";
                string senderName = isMe ? "Ty" : (msg.User?.UserName ?? "Support");
                string msgAvatar = GetAvatarBase64(msg.User);

                string avatarBorderColor = "var(--neon-cyan)";
                if (await UserManager.IsInRoleAsync(msg.User, "Admin")) { avatarBorderColor = "var(--neon-red)"; }
                else if (await UserManager.IsInRoleAsync(msg.User, "Moderator")) { avatarBorderColor = "var(--neon-green)"; }
                if (isMe) { avatarBorderColor = "var(--neon-cyan)"; }

                <div class="msg-row @alignmentClass @roleClass">
                    @if (!isMe)
                    {
                        <img src="@msgAvatar" class="msg-avatar" style="border-color: @avatarBorderColor;">
                    }

                    <div class="msg-bubble">
                        <div class="msg-meta @(isMe ? "text-end" : "text-start")">
                            @senderName • @msg.CreatedAt.ToString("dd.MM HH:mm")
                        </div>

                        <div class="msg-content">
                            @if (!string.IsNullOrEmpty(msg.Message))
                            {
                                <div>@msg.Message</div>
                            }

                            @if (msg.Attachments != null && msg.Attachments.Any())
                            {
                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    @foreach (var att in msg.Attachments)
                                    {
                                        string imgBase64 = $"data:{att.ContentType};base64,{Convert.ToBase64String(att.FileContent)}";
                                        <div class="position-relative">
                                            <img src="@imgBase64" class="rounded border border-secondary"
                                                 style="width: 100px; height: 100px; object-fit: cover; cursor: pointer;"
                                                 data-bs-toggle="modal" data-bs-target="#imgModal-@att.Id" />
                                        </div>

                                        <div class="modal fade" id="imgModal-@att.Id" tabindex="-1">
                                            <div class="modal-dialog modal-lg modal-dialog-centered">
                                                <div class="modal-content bg-transparent border-0 shadow-none">
                                                    <div class="modal-body text-center p-0 position-relative">
                                                        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>
                                                        <img src="@imgBase64" class="img-fluid rounded shadow-lg border border-secondary" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    @if (isMe)
                    {
                        <img src="@msgAvatar" class="msg-avatar" style="border-color: @avatarBorderColor;">
                    }
                </div>
            }
        </div>

        @* --- PANEL WPISYWANIA --- *@
        @if (Model.Status != praca_dyplomowa_zesp.Models.TicketStatus.Zamknięte)
        {
            <div class="chat-footer">
                <form asp-action="Reply" method="post" enctype="multipart/form-data" id="replyForm">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div id="previews" class="mb-2"></div>

                    <input type="file" name="attachments" id="attachmentInput" class="d-none" multiple accept="image/*" />

                    <div class="chat-input-merged">
                        <button type="button" class="btn-attachment ps-3" onclick="document.getElementById('attachmentInput').click()" title="Dodaj plik">
                            <i class="fas fa-paperclip"></i>
                        </button>

                        <div class="form-floating flex-grow-1">
                            <textarea name="message" id="messageInput" class="form-control" placeholder="Wpisz wiadomość..." style="height: 55px;"></textarea>
                            <label for="messageInput">Napisz wiadomość... (Ctrl+V aby wkleić)</label>
                        </div>

                        <button type="submit" class="btn-send-integrated">
                            WYŚLIJ <i class="fas fa-paper-plane ms-2"></i>
                        </button>
                    </div>
                </form>
            </div>
        }
        else
        {
            <div class="p-4 text-center bg-dark border-top border-secondary text-muted">
                <i class="fas fa-lock me-2"></i> To zgłoszenie zostało zamknięte. Odpowiadanie jest niemożliwe.
            </div>
        }
    </div>
</div>

<script>
    var chatBox = document.getElementById('chatBox');
    if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;

    const dt = new DataTransfer();
    const attachmentInput = document.getElementById('attachmentInput');
    const previewsDiv = document.getElementById('previews');

    function isImage(file) {
        return file && file.type.startsWith('image/');
    }

    // --- FUNKCJA BŁĘDU (POPUP NA ŚRODKU) ---
    function showError(message) {
        const container = document.getElementById('toast-container');

        // Stylowanie powiadomienia "na środku" - dodajemy cień i większy padding
        const alertHtml = document.createElement('div');
        alertHtml.className = 'alert alert-neon alert-neon-danger d-flex align-items-center mb-3 fade-in-up shadow-lg';
        alertHtml.role = 'alert';
        alertHtml.style.borderWidth = '2px'; // Grubsza ramka dla ważności

        alertHtml.innerHTML = `
            <i class="fas fa-exclamation-triangle me-4 fs-2"></i>
            <div class="flex-grow-1">
                <div class="fw-bold text-uppercase mb-1" style="letter-spacing:1px; font-size: 0.9rem;">Błąd Systemu</div>
                <div class="small opacity-75">${message}</div>
            </div>
            <button type="button" class="btn-close btn-close-white ms-3" onclick="this.parentElement.remove()"></button>
        `;

        container.appendChild(alertHtml);

        setTimeout(() => {
            alertHtml.classList.add('opacity-0');
            setTimeout(() => alertHtml.remove(), 500);
        }, 4000);
    }

    attachmentInput?.addEventListener('change', function(){
        let invalidFiles = false;
        for(let i = 0; i < this.files.length; i++){
            const file = this.files[i];
            if(isImage(file)){
                dt.items.add(file);
            } else {
                invalidFiles = true;
            }
        }

        if(invalidFiles) {
            showError("Wykryto nieprawidłowy format danych. Dozwolone są tylko pliki graficzne.");
        }

        updateFiles();
    });

    document.getElementById('messageInput')?.addEventListener('paste', function (e) {
        var items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (var index in items) {
            var item = items[index];
            if (item.kind === 'file') {
                var blob = item.getAsFile();
                if(isImage(blob)){
                    dt.items.add(blob);
                    updateFiles();
                } else {
                    showError("Schowek zawiera nieobsługiwany typ danych. Wklej obraz.");
                }
            }
        }
    });

    function updateFiles(){
        attachmentInput.files = dt.files;
        renderPreviews();
    }

    function renderPreviews(){
        previewsDiv.innerHTML = '';
        for(let i = 0; i < dt.files.length; i++){
            const file = dt.files[i];
            const reader = new FileReader();
            reader.onload = function(e){
                const div = document.createElement('div');
                div.className = 'attachment-preview-wrapper';
                div.innerHTML = `
                    <img src="${e.target.result}" class="attachment-preview-img" />
                    <button type="button" class="btn-remove-attachment" onclick="removeFile(${i})">
                        <i class="fas fa-times-circle"></i>
                    </button>
                `;
                previewsDiv.appendChild(div);
            }
            reader.readAsDataURL(file);
        }
    }

    window.removeFile = function(index){
        dt.items.remove(index);
        updateFiles();
    }
</script>