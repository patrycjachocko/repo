@model praca_dyplomowa_zesp.Models.Ticket
@using Microsoft.AspNetCore.Identity
@using praca_dyplomowa_zesp.Models.Users
@inject UserManager<User> UserManager

@{
    ViewData["Title"] = "Szczegóły zgłoszenia";
    var currentUser = await UserManager.GetUserAsync(User);
}

<style>
    /* --- STYL CZATU (Cyberpunk Messenger) --- */

    .chat-container {
        display: flex;
        flex-direction: column;
        height: 70vh; /* Stała wysokość dla okna czatu */
        background: rgba(22, 22, 28, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        overflow: hidden;
    }

    /* Nagłówek Czatu */
    .chat-header {
        padding: 20px;
        background: rgba(30, 30, 35, 0.95);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* NOWE: Neonowa ikona biletu */
    .ticket-icon-neon {
        color: #00f3ff; /* Neonowy cyjan */
        text-shadow: 0 0 10px rgba(0, 243, 255, 0.6); /* Poświata */
        margin-right: 8px;
        font-size: 1.1rem; /* Nieco większa niż tekst */
    }

    /* ZAKTUALIZOWANA KLASA: Wyrównanie ID i ikony */
    .ticket-id {
        font-size: 0.8rem;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 1px;
        /* Dodajemy flexbox dla idealnego wyrównania */
        display: flex;
        align-items: center;
    }

    .ticket-topic {
        font-weight: 700;
        font-size: 1.1rem;
        color: #fff;
        margin-top: 5px; /* Lekki odstęp od ID */
    }

    /* Obszar Wiadomości */
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 15px;
        background: #0b0b0e;
        /* Scrollbar styling */
        scrollbar-width: thin;
        scrollbar-color: var(--mid-pink) #1a1a20;
    }

    /* Dymki wiadomości */
    .msg-wrapper {
        display: flex;
        flex-direction: column;
        max-width: 75%;
    }

    .msg-bubble {
        padding: 12px 18px;
        border-radius: 18px;
        position: relative;
        font-size: 0.95rem;
        line-height: 1.5;
        word-wrap: break-word;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Wiadomość Użytkownika (Prawa strona) */
    .msg-user {
        align-self: flex-end;
    }

        .msg-user .msg-bubble {
            background: linear-gradient(135deg, var(--deep-purple), var(--mid-pink));
            color: white;
            border-bottom-right-radius: 4px;
        }

        .msg-user .msg-meta {
            text-align: right;
        }

    /* Wiadomość Admina/Supportu (Lewa strona) */
    .msg-admin {
        align-self: flex-start;
    }

        .msg-admin .msg-bubble {
            background: #2a2a30;
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom-left-radius: 4px;
        }

        .msg-admin .msg-meta {
            text-align: left;
        }

    .msg-meta {
        font-size: 0.7rem;
        color: #666;
        margin-top: 4px;
        margin-bottom: 2px;
    }

    /* Załączniki w wiadomości */
    .msg-attachment {
        margin-top: 10px;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid rgba(255,255,255,0.2);
        cursor: pointer;
        transition: transform 0.2s;
    }

        .msg-attachment:hover {
            transform: scale(1.02);
        }

    /* Panel wpisywania (Stopka) */
    .chat-input-area {
        padding: 15px 20px;
        background: rgba(30, 30, 35, 0.95);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .input-wrapper {
        background: #16161c;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 25px;
        display: flex;
        align-items: center;
        padding: 5px 15px;
        transition: border-color 0.3s;
    }

        .input-wrapper:focus-within {
            border-color: var(--mid-pink);
            box-shadow: 0 0 10px rgba(255, 102, 196, 0.2);
        }

    .chat-textarea {
        background: transparent;
        border: none;
        color: #fff;
        resize: none;
        width: 100%;
        max-height: 100px;
        padding: 10px 0;
        outline: none;
    }

    .btn-attach {
        color: #888;
        background: transparent;
        border: none;
        font-size: 1.2rem;
        margin-right: 10px;
        transition: color 0.3s;
    }

        .btn-attach:hover {
            color: #fff;
        }

    .btn-send-msg {
        background: var(--mid-pink);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: 10px;
        transition: transform 0.2s;
    }

        .btn-send-msg:hover {
            transform: scale(1.1);
            background: #ff3366;
        }

    /* Miniatury w panelu wysyłania */
    .upload-preview-container {
        display: flex;
        gap: 10px;
        padding: 10px 0;
        overflow-x: auto;
    }

    .upload-thumb-wrapper {
        position: relative;
        width: 60px;
        height: 60px;
    }

    .upload-thumb {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #555;
    }

    .btn-remove-upload {
        position: absolute;
        top: -5px;
        right: -5px;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #ff3366;
        color: #fff;
        border: none;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    /* Statusy */
    .status-badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .status-open {
        background: rgba(0, 255, 157, 0.15);
        color: #00ff9d;
        border: 1px solid rgba(0, 255, 157, 0.4);
    }

    .status-progress {
        background: rgba(255, 193, 7, 0.15);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.4);
    }

    .status-closed {
        background: rgba(108, 117, 125, 0.15);
        color: #adb5bd;
        border: 1px solid rgba(108, 117, 125, 0.4);
    }

</style>

<div class="container mt-4 mb-5">

    <div class="mb-3">
        <a asp-action="Index" class="btn btn-sm btn-outline-secondary rounded-pill px-3">
            <i class="fas fa-arrow-left me-1"></i> Wróć do listy
        </a>
    </div>

    <div class="chat-container">

        @* --- HEADER --- *@
        <div class="chat-header">
            <div>
                @* ZMIANA: Dodano ikonę i poprawiono strukturę *@
                <div class="ticket-id">
                    <i class="fas fa-ticket-alt ticket-icon-neon"></i> Ticket #@Model.Id
                </div>
                <div class="ticket-topic">@Model.Title</div>
            </div>
            <div>
                @if (Model.Status == praca_dyplomowa_zesp.Models.TicketStatus.Oczekujące)
                {
                    <span class="status-badge status-open">Oczekujące</span>
                }
                else if (Model.Status == praca_dyplomowa_zesp.Models.TicketStatus.W_trakcie)
                {
                    <span class="status-badge status-progress">W trakcie</span>
                }
                else
                {
                    <span class="status-badge status-closed">Zamknięte</span>
                }
            </div>
        </div>

        @* --- OBSZAR WIADOMOŚCI --- *@
        <div class="chat-messages" id="chatBox">

            @* Pierwsza wiadomość (Treść zgłoszenia) - Zawsze jako User *@
            <div class="msg-wrapper msg-user">
                <div class="msg-meta">Ty • @Model.CreatedAt.ToString("dd.MM HH:mm")</div>
                <div class="msg-bubble">
                    @Model.Content
                </div>
            </div>

            @* Pętla po wiadomościach *@
            @foreach (var msg in Model.Messages.OrderBy(m => m.CreatedAt))
            {
                bool isMe = msg.UserId == currentUser.Id;
                <div class="msg-wrapper @(isMe ? "msg-user" : "msg-admin")">
                    <div class="msg-meta">
                        @(isMe ? "Ty" : msg.User?.UserName ?? "Support") • @msg.CreatedAt.ToString("dd.MM HH:mm")
                    </div>

                    <div class="msg-bubble">
                        @if (!string.IsNullOrEmpty(msg.Message))
                        {
                            <div>@msg.Message</div>
                        }

                        @* Załączniki *@
                        @if (msg.Attachments != null && msg.Attachments.Any())
                        {
                            <div class="d-flex flex-wrap gap-2 mt-2">
                                @foreach (var att in msg.Attachments)
                                {
                                    <img src="data:@att.ContentType;base64,@Convert.ToBase64String(att.FileContent)"
                                         class="msg-attachment"
                                         style="width: 100px; height: 100px; object-fit: cover;"
                                         data-bs-toggle="modal" data-bs-target="#imgModal-@att.Id" />

                                    @* Modal podglądu *@
                                    <div class="modal fade" id="imgModal-@att.Id" tabindex="-1">
                                        <div class="modal-dialog modal-lg modal-dialog-centered">
                                            <div class="modal-content bg-transparent border-0 shadow-none">
                                                <div class="modal-body text-center p-0">
                                                    <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal"></button>
                                                    <img src="data:@att.ContentType;base64,@Convert.ToBase64String(att.FileContent)" class="img-fluid rounded shadow-lg" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
        </div>

        @* --- PANEL WPISYWANIA --- *@
        @if (Model.Status != praca_dyplomowa_zesp.Models.TicketStatus.Zamknięte)
        {
            <div class="chat-input-area">
                <form asp-action="Reply" method="post" enctype="multipart/form-data" id="replyForm">
                    <input type="hidden" name="id" value="@Model.Id" />

                    @* Kontener na miniatury dodawanych plików *@
                    <div id="previews" class="upload-preview-container"></div>

                    <input type="file" name="attachments" id="attachmentInput" class="d-none" multiple accept="image/*" />

                    <div class="input-wrapper">
                        <button type="button" class="btn-attach" onclick="document.getElementById('attachmentInput').click()" title="Dodaj plik">
                            <i class="fas fa-paperclip"></i>
                        </button>

                        <textarea name="message" id="messageInput" class="chat-textarea" rows="1" placeholder="Napisz wiadomość... (Ctrl+V aby wkleić zdjęcie)"></textarea>

                        <button type="submit" class="btn-send-msg" title="Wyślij">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        }
        else
        {
            <div class="p-3 text-center bg-dark border-top border-secondary text-muted">
                <i class="fas fa-lock me-2"></i> To zgłoszenie zostało zamknięte.
            </div>
        }
    </div>
</div>

<script>
    // Automatyczne przewijanie na dół
    var chatBox = document.getElementById('chatBox');
    if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;

    // Obsługa plików
    const dt = new DataTransfer();
    const attachmentInput = document.getElementById('attachmentInput');
    const previewsDiv = document.getElementById('previews');

    attachmentInput?.addEventListener('change', function(){
        for(let i = 0; i < this.files.length; i++){
            dt.items.add(this.files[i]);
        }
        updateFiles();
    });

    // Obsługa wklejania (Paste)
    document.getElementById('messageInput')?.addEventListener('paste', function (e) {
        var items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (var index in items) {
            var item = items[index];
            if (item.kind === 'file' && item.type.startsWith('image/')) {
                dt.items.add(item.getAsFile());
                updateFiles();
            }
        }
    });

    // Auto-resize textarea
    const tx = document.getElementById('messageInput');
    if(tx){
        tx.setAttribute("style", "height:" + (tx.scrollHeight) + "px;overflow-y:hidden;");
        tx.addEventListener("input", OnInput, false);
    }

    function OnInput() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + "px";
    }

    function updateFiles(){
        attachmentInput.files = dt.files;
        renderPreviews();
    }

    function renderPreviews(){
        previewsDiv.innerHTML = '';
        for(let i = 0; i < dt.files.length; i++){
            const file = dt.files[i];
            const reader = new FileReader();
            reader.onload = function(e){
                const div = document.createElement('div');
                div.className = 'upload-thumb-wrapper';
                div.innerHTML = `
                    <img src="${e.target.result}" class="upload-thumb" />
                    <button type="button" class="btn-remove-upload" onclick="removeFile(${i})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                previewsDiv.appendChild(div);
            }
            reader.readAsDataURL(file);
        }
    }

    window.removeFile = function(index){
        dt.items.remove(index);
        updateFiles();
    }
</script>