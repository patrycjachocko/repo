@using praca_dyplomowa_zesp.Models.Interactions.Reactions
@using praca_dyplomowa_zesp.Models.ViewModels
@* Wstrzykujemy kontekst, aby pobrać oceny wszystkich użytkowników dla tej gry *@
@inject praca_dyplomowa.Data.ApplicationDbContext _context
@model List<praca_dyplomowa_zesp.Models.Modules.Games.GameReview>

@{
    ViewData["Title"] = "Recenzje - " + ViewBag.GameName;
    long gameId = ViewBag.GameId;
    string gameName = ViewBag.GameName;
    string currentSort = ViewBag.CurrentSort as string ?? "best";

    var currentUserIdStr = ViewBag.CurrentUserId as string;
    Guid currentUserId = Guid.Empty;
    if (!string.IsNullOrEmpty(currentUserIdStr))
    {
        Guid.TryParse(currentUserIdStr, out currentUserId);
    }

    bool isAdminOrMod = User.IsInRole("Admin") || User.IsInRole("Moderator");

    // Pobieramy model ogólnych ocen
    var ratingsModel = ViewBag.Ratings as GameRatingViewModel;
    double myCurrentRating = ratingsModel?.UserPersonalRating ?? 0;

    // SŁOWNIK OCEN: Pobieramy aktualne oceny z bazy
    var userRatings = _context.GameRates
        .Where(r => r.IgdbGameId == gameId)
        .ToDictionary(r => r.UserId, r => r.Value);

    // --- LOGIKA SORTOWANIA (NAPRAWA SORTOWANIA PO OCENACH) ---
    // Sortujemy tutaj, ponieważ mamy dostęp do 'userRatings', które jest zawsze aktualne.
    IEnumerable<praca_dyplomowa_zesp.Models.Modules.Games.GameReview> reviewsToDisplay = Model;

    if (reviewsToDisplay != null)
    {
        if (currentSort == "highest_rating")
        {
            // Sortuj malejąco po ocenie (jeśli brak oceny to traktuj jako 0), potem po dacie
            reviewsToDisplay = reviewsToDisplay
                .OrderByDescending(r => userRatings.ContainsKey(r.UserId) ? userRatings[r.UserId] : 0)
                .ThenByDescending(r => r.CreatedAt);
        }
        else if (currentSort == "lowest_rating")
        {
            // Sortuj rosnąco po ocenie.
            // Uwaga: Jeśli ocena wynosi 0 (brak oceny), wyrzucamy na koniec czy na początek?
            // Zwykle "najniższa" to 1. Ustawmy brak oceny jako bardzo dużą liczbę, żeby były na końcu,
            // ALBO jako 0, wtedy będą na początku.
            // Przyjmijmy: sortujemy od 1 w górę. (0 traktujemy jako brak danych -> na koniec).

            reviewsToDisplay = reviewsToDisplay
                .OrderBy(r => userRatings.ContainsKey(r.UserId) ? userRatings[r.UserId] : 999)
                .ThenByDescending(r => r.CreatedAt);
        }
        else
        {
            // Domyślne sortowanie (Newest, Best, Popular) przychodzi z kontrolera
            // więc tutaj nic nie zmieniamy.
        }
    }
}

<div class="container mt-4">

    @* --- NAGŁÓWEK I POWRÓT --- *@
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a asp-controller="Games" asp-action="Details" asp-route-id="@gameId" class="btn btn-outline-secondary">
            &larr; Wróć do gry
        </a>

        @if (User.Identity.IsAuthenticated)
        {
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReviewModal">
                <i class="bi bi-pencil-square"></i> Napisz recenzję
            </button>
        }
    </div>

    @* --- TYTUŁ --- *@
    <div class="mb-4 pb-2 border-bottom">
        <h2 class="mb-0">Recenzje gry: <span class="text-primary">@gameName</span></h2>
    </div>

    @* --- SEKCJA OCEN (OGÓLNA) --- *@
    <div class="mb-5">
        @if (ratingsModel != null)
        {
            <partial name="_GameRatingPartial" model="ratingsModel" />
        }
    </div>

    @* --- MENU SORTOWANIA --- *@
    <div class="d-flex justify-content-end mb-3">
        <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="sortMenu" data-bs-toggle="dropdown" aria-expanded="false">
                Sortuj:
                @if (currentSort == "newest")
                {
                    <strong>Najnowsze</strong>
                }
                else if (currentSort == "popular")
                {
                    <strong>Najpopularniejsze</strong>
                }
                else if (currentSort == "highest_rating")
                {
                    <strong>Najwyższe oceny</strong>
                }
                else if (currentSort == "lowest_rating")
                {
                    <strong>Najniższe oceny</strong>
                }
                else
                {
                    <strong>Najlepsze</strong>
                }
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="sortMenu">
                <li>
                    <a class="dropdown-item @(currentSort == "best" ? "active" : "")"
                       asp-action="Index" asp-route-gameId="@gameId" asp-route-gameName="@gameName" asp-route-sortOrder="best">
                        Najlepsze (Domyślne)
                    </a>
                </li>
                <li>
                    <a class="dropdown-item @(currentSort == "newest" ? "active" : "")"
                       asp-action="Index" asp-route-gameId="@gameId" asp-route-gameName="@gameName" asp-route-sortOrder="newest">
                        Najnowsze
                    </a>
                </li>
                <li>
                    <a class="dropdown-item @(currentSort == "popular" ? "active" : "")"
                       asp-action="Index" asp-route-gameId="@gameId" asp-route-gameName="@gameName" asp-route-sortOrder="popular">
                        Najpopularniejsze
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <a class="dropdown-item @(currentSort == "highest_rating" ? "active" : "")"
                       asp-action="Index" asp-route-gameId="@gameId" asp-route-gameName="@gameName" asp-route-sortOrder="highest_rating">
                        Najwyższe oceny
                    </a>
                </li>
                <li>
                    <a class="dropdown-item @(currentSort == "lowest_rating" ? "active" : "")"
                       asp-action="Index" asp-route-gameId="@gameId" asp-route-gameName="@gameName" asp-route-sortOrder="lowest_rating">
                        Najniższe oceny
                    </a>
                </li>
            </ul>
        </div>
    </div>

    @* --- KOMUNIKATY --- *@
    @if (TempData["StatusMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["StatusMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (!User.Identity.IsAuthenticated)
    {
        <div class="alert alert-info">
            <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path">Zaloguj się</a>, aby dodać recenzję i oceniać inne.
        </div>
    }

    @* --- LISTA RECENZJI (UŻYWAMY POSORTOWANEJ ZMIENNEJ reviewsToDisplay) --- *@
    @if (reviewsToDisplay != null && reviewsToDisplay.Any())
    {
        foreach (var review in reviewsToDisplay)
        {
            // --- LOGIKA PUNKTACJI (ŁAPKI) ---
            var likes = review.Reactions?.Count(r => r.Type == ReactionType.Like) ?? 0;
            var dislikes = review.Reactions?.Count(r => r.Type == ReactionType.Dislike) ?? 0;
            var score = likes - dislikes;

            bool userLiked = currentUserId != Guid.Empty && (review.Reactions?.Any(r => r.UserId == currentUserId && r.Type == ReactionType.Like) ?? false);
            bool userDisliked = currentUserId != Guid.Empty && (review.Reactions?.Any(r => r.UserId == currentUserId && r.Type == ReactionType.Dislike) ?? false);

            string scoreClass = "text-secondary";
            string sign = "";

            if (score > 0) { scoreClass = "text-success fw-bold"; sign = "+"; }
            else if (score < 0) { scoreClass = "text-danger fw-bold"; }

            // --- LOGIKA KOLORU ROLI ---
            string nickClass = "text-primary";
            var userRole = review.User?.Role?.ToLower();

            if (userRole == "admin") { nickClass = "text-danger fw-bold"; }
            else if (userRole == "moderator") { nickClass = "text-success fw-bold"; }

            // --- POBIERANIE OCENY AUTORA (GWIAZDKI) ---
            double authorRating = 0;
            if (userRatings.ContainsKey(review.UserId))
            {
                authorRating = userRatings[review.UserId];
            }

            // --- LOGIKA UPRAWNIEŃ ---
            bool isAuthor = review.UserId == currentUserId;
            bool canEdit = isAuthor;
            bool canDelete = isAuthor || isAdminOrMod;

            <div class="card mb-3 shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center bg-transparent py-2">

                    @* LEWA STRONA: AVATAR + INFO *@
                    <div class="d-flex align-items-center">
                        @if (review.User?.ProfilePicture != null)
                        {
                            <img src="@Url.Action("GetAvatar", "Profile", new { id = review.UserId })"
                                 alt="Avatar" class="rounded-circle me-3"
                                 style="width: 42px; height: 42px; object-fit: cover; border: 2px solid #fff; box-shadow: 0 0 2px rgba(0,0,0,0.2);" />
                        }
                        else
                        {
                            <img src="~/uploads/avatars/default_avatar.png"
                                 alt="Avatar" class="rounded-circle me-3"
                                 style="width: 42px; height: 42px; object-fit: cover; border: 2px solid #fff; box-shadow: 0 0 2px rgba(0,0,0,0.2);" />
                        }

                        <div class="d-flex flex-column">
                            <div>
                                <strong style="font-size: 1.05rem;" class="@nickClass">@review.User?.UserName</strong>

                                @* WYŚWIETLANIE OCENY (GWIAZDKA) - Format 0.# *@
                                @if (authorRating > 0)
                                {
                                    <span class="badge bg-warning text-dark ms-2" title="Ocena gry wystawiona przez autora">
                                        <i class="fas fa-star"></i>
                                        @authorRating.ToString("0.#", System.Globalization.CultureInfo.InvariantCulture)
                                    </span>
                                }
                            </div>
                            <small class="text-muted">@review.CreatedAt.ToString("g")</small>
                        </div>
                    </div>

                    @* PRAWA STRONA: MENU + ŁAPKI *@
                    <div class="d-flex align-items-center gap-3">

                        @* MENU OPCJI *@
                        @if (canEdit || canDelete)
                        {
                            <div class="dropdown">
                                <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots-vertical" style="font-size: 1.2rem;"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    @if (canEdit)
                                    {
                                        <li>
                                            @* Przekazujemy authorRating jako int (rzutowanie na int) lub sformatowany string *@
                                            <a class="dropdown-item" href="#" onclick="openEditModal(@review.Id, 'review-content-@review.Id', @(authorRating > 0 ? ((int)authorRating).ToString() : "0"))">
                                                <i class="bi bi-pencil me-2"></i> Edytuj
                                            </a>
                                        </li>
                                    }
                                    @if (canDelete)
                                    {
                                        <li>
                                            <a class="dropdown-item text-danger" href="#" onclick="openDeleteModal(@review.Id)">
                                                <i class="bi bi-trash me-2"></i> Usuń
                                            </a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }

                        @* GŁOSOWANIE *@
                        <div class="d-flex align-items-center gap-2 border-start ps-3">
                            <form asp-controller="Reviews" asp-action="ToggleReaction" method="post" class="d-inline">
                                <input type="hidden" name="reviewId" value="@review.Id" />
                                <input type="hidden" name="isUpvote" value="true" />
                                <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />

                                <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent @(userLiked ? "text-success" : "text-secondary")" title="Pomocne">
                                    <i class="@(userLiked ? "bi bi-hand-thumbs-up-fill" : "bi bi-hand-thumbs-up")" style="font-size: 1.3rem;"></i>
                                </button>
                            </form>

                            <span class="@scoreClass mx-1" style="font-size: 1.2rem; min-width: 35px; text-align: center;">
                                @sign@score
                            </span>

                            <form asp-controller="Reviews" asp-action="ToggleReaction" method="post" class="d-inline">
                                <input type="hidden" name="reviewId" value="@review.Id" />
                                <input type="hidden" name="isUpvote" value="false" />
                                <input type="hidden" name="returnUrl" value="@Context.Request.Path@Context.Request.QueryString" />

                                <button type="submit" class="btn btn-sm p-0 border-0 bg-transparent @(userDisliked ? "text-danger" : "text-secondary")" title="Słabe">
                                    <i class="@(userDisliked ? "bi bi-hand-thumbs-down-fill" : "bi bi-hand-thumbs-down")" style="font-size: 1.3rem;"></i>
                                </button>
                            </form>
                        </div>

                    </div>
                </div>
                <div class="card-body">
                    <p class="card-text" style="white-space: pre-wrap;" id="review-content-@review.Id">@review.Content</p>
                </div>
            </div>
        }
    }
    else
    {
        <p class="text-muted text-center mt-5 display-6">Brak recenzji.</p>
        <p class="text-center">Bądź pierwszą osobą, która podzieli się opinią!</p>
    }
</div>

@if (User.Identity.IsAuthenticated)
{
    @* --- SKRYPTY I STYLE DLA GWIAZDEK --- *@
    <style>
        .star-rating {
            font-size: 1.5rem;
            cursor: pointer;
            color: #ccc;
        }

            .star-rating .fa-star {
                transition: color 0.2s;
            }

                .star-rating .fa-star.checked {
                    color: #ffc107;
                }

                .star-rating .fa-star:hover {
                    color: #ffdb58;
                }
    </style>

    @* MODAL: DODAJ RECENZJĘ *@
    <div class="modal fade" id="addReviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form asp-action="Create" method="post" id="createReviewForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Twoja recenzja: @gameName</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="gameId" value="@gameId" />
                        <input type="hidden" name="gameName" value="@gameName" />

                        @* OCENA GWIAZDKOWA *@
                        <div class="mb-3">
                            <label class="form-label fw-bold">Twoja ocena <span class="text-danger">*</span>:</label>
                            <div class="star-rating" id="createRatingStars">
                                <i class="far fa-star" data-value="1"></i>
                                <i class="far fa-star" data-value="2"></i>
                                <i class="far fa-star" data-value="3"></i>
                                <i class="far fa-star" data-value="4"></i>
                                <i class="far fa-star" data-value="5"></i>
                                <i class="far fa-star" data-value="6"></i>
                                <i class="far fa-star" data-value="7"></i>
                                <i class="far fa-star" data-value="8"></i>
                                <i class="far fa-star" data-value="9"></i>
                                <i class="far fa-star" data-value="10"></i>
                                @* Rzutujemy na int przy wyświetlaniu startowym *@
                                <span class="ms-2 fs-6 text-muted" id="createRatingText">@(myCurrentRating > 0 ? ((int)myCurrentRating).ToString() : "Brak")</span>
                            </div>
                            <input type="hidden" id="createRatingValue" value="@((int)myCurrentRating)" />
                            @* Komunikat błędu *@
                            <div id="ratingError" class="text-danger small mt-1 d-none">Musisz ocenić grę (min. 1 gwiazdka), aby dodać recenzję.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Treść recenzji</label>
                            <textarea name="content" class="form-control" rows="6" placeholder="Napisz, co Ci się podobało..." required maxlength="2000"></textarea>
                            <div class="form-text">Maksymalnie 2000 znaków.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                        <button type="button" class="btn btn-primary" onclick="submitCreateReview()">Opublikuj</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    @* MODAL: EDYTUJ RECENZJĘ *@
    <div class="modal fade" id="editReviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form asp-action="Edit" method="post" id="editReviewForm">
                    <div class="modal-header">
                        <h5 class="modal-title">Edytuj recenzję</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="id" id="editReviewId" />
                        <input type="hidden" name="gameName" value="@gameName" />

                        @* OCENA GWIAZDKOWA (EDYCJA) *@
                        <div class="mb-3">
                            <label class="form-label fw-bold">Twoja ocena:</label>
                            <div class="star-rating" id="editRatingStars">
                                <i class="far fa-star" data-value="1"></i>
                                <i class="far fa-star" data-value="2"></i>
                                <i class="far fa-star" data-value="3"></i>
                                <i class="far fa-star" data-value="4"></i>
                                <i class="far fa-star" data-value="5"></i>
                                <i class="far fa-star" data-value="6"></i>
                                <i class="far fa-star" data-value="7"></i>
                                <i class="far fa-star" data-value="8"></i>
                                <i class="far fa-star" data-value="9"></i>
                                <i class="far fa-star" data-value="10"></i>
                                <span class="ms-2 fs-6 text-muted" id="editRatingText"></span>
                            </div>
                            <input type="hidden" id="editRatingValue" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Treść recenzji</label>
                            <textarea name="content" id="editReviewContent" class="form-control" rows="6" required maxlength="2000"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                        <button type="button" class="btn btn-primary" onclick="submitEditReview()">Zapisz zmiany</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    @* MODAL: USUŃ RECENZJĘ *@
    <div class="modal fade" id="deleteReviewModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="Delete" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title text-danger">Usuń recenzję</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Czy na pewno chcesz usunąć tę recenzję? Tej operacji nie można cofnąć.</p>
                        <input type="hidden" name="id" id="deleteReviewId" />
                        <input type="hidden" name="gameName" value="@gameName" />
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                        <button type="submit" class="btn btn-danger">Usuń</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function getToken() {
            var tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            return tokenInput ? tokenInput.value : '';
        }

        // --- OBSŁUGA GWIAZDEK ---
        function initStars(containerId, inputId, textId, initialValue) {
            const container = document.getElementById(containerId);
            const input = document.getElementById(inputId);
            const text = document.getElementById(textId);
            const stars = container.querySelectorAll('i');

            function drawStars(val) {
                // Konwersja na int (wymuszenie liczby całkowitej)
                val = parseInt(val);
                stars.forEach(s => {
                    const v = parseInt(s.getAttribute('data-value'));
                    s.className = v <= val ? 'fas fa-star text-warning' : 'far fa-star';
                });

                if (val >= 1) {
                     text.innerText = val;
                } else {
                     text.innerText = "Brak";
                }
            }

            // Inicjalizacja: jeśli initialValue było np. 7.5, parseInt zamieni to na 7.
            // Jeśli było 0.5 -> 0.
            drawStars(initialValue);

            stars.forEach(s => {
                s.addEventListener('click', function() {
                    const val = parseInt(this.getAttribute('data-value'));
                    input.value = val;
                    drawStars(val);
                    // Ukryj błąd jeśli wybrano ocenę >= 1
                    const err = document.getElementById('ratingError');
                    if(err) err.classList.add('d-none');
                });
            });
        }

        document.addEventListener("DOMContentLoaded", function() {
            // Przekazujemy initialValue jako @((int)myCurrentRating)
            initStars('createRatingStars', 'createRatingValue', 'createRatingText', @((int)myCurrentRating));
        });

        // --- LOGIKA MODALI ---
        function openEditModal(id, contentId, currentRating) {
            var content = document.getElementById(contentId).innerText;
            document.getElementById('editReviewId').value = id;
            document.getElementById('editReviewContent').value = content;

            // Wymuszamy int przy otwieraniu modala edycji
            var intRating = parseInt(currentRating);
            document.getElementById('editRatingValue').value = intRating;

            initStars('editRatingStars', 'editRatingValue', 'editRatingText', intRating);

            var modal = new bootstrap.Modal(document.getElementById('editReviewModal'));
            modal.show();
        }

        function openDeleteModal(id) {
            document.getElementById('deleteReviewId').value = id;
            var modal = new bootstrap.Modal(document.getElementById('deleteReviewModal'));
            modal.show();
        }

        // --- WYSYŁANIE FORMULARZY Z OCENĄ ---
        function submitCreateReview() {
            const ratingInput = document.getElementById('createRatingValue');
            const rating = parseInt(ratingInput.value); // Wymuś Int
            const gameId = @gameId;

            // WALIDACJA: Ocena >= 1 jest wymagana
            if (!rating || rating < 1) {
                document.getElementById('ratingError').classList.remove('d-none');
                return; // Stop
            }

            // Wysyłamy ocenę, potem recenzję
            fetch('/Games/RateGame', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': getToken()
                },
                body: JSON.stringify({ gameId: gameId, ratingValue: rating })
            }).then(() => {
                document.getElementById('createReviewForm').submit();
            });
        }

        function submitEditReview() {
            const ratingVal = document.getElementById('editRatingValue').value;
            const rating = parseInt(ratingVal);
            const gameId = @gameId;

            if (rating >= 1) {
                fetch('/Games/RateGame', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': getToken()
                    },
                    body: JSON.stringify({ gameId: gameId, ratingValue: rating })
                }).then(() => {
                    document.getElementById('editReviewForm').submit();
                });
            } else {
                // Jeśli użytkownik zresetował ocenę (nie klikał gwiazdek), wysyłamy samą treść
                document.getElementById('editReviewForm').submit();
            }
        }
    </script>
}