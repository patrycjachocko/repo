@model praca_dyplomowa_zesp.Models.Modules.Games.GameBrowserViewModel
@{
    ViewData["Title"] = ViewData["Title"] ?? "Przeglądaj Gry";
}

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>@ViewData["Title"]</h1>
    </div>

    @* PANEL FILTRÓW I WYSZUKIWANIA *@
    @if (Model.Mode == "browse")
    {
        <div class="card bg-dark border-secondary mb-4">
            <div class="card-body py-3">
                <form asp-action="Index" method="get" class="row g-3 align-items-center">
                    <input type="hidden" name="mode" value="browse" />

                    @* --- FLAGA FILTROWANIA (Ważne!) --- *@
                    <input type="hidden" name="isFiltered" value="true" />

                    @* --- WYSZUKIWARKA --- *@
                    <div class="col-md-5">
                        <div class="input-group">
                            <input type="text" name="searchString" class="form-control bg-dark text-white border-secondary" placeholder="Szukaj gry..." value="@Model.SearchString" />
                            <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>
                    </div>

                    @* --- CHECKBOXY --- *@
                    <div class="col-md-7">
                        <div class="d-flex gap-3 justify-content-md-end align-items-center flex-wrap">
                            <span class="text-muted small text-uppercase fw-bold">Licz ocenę z:</span>

                            @* 1. KRYTYCY *@
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="checkCritic" name="showCritic" value="true" @(Model.ShowIgdbCritic ? "checked" : "") onchange="this.form.submit()">
                                <label class="form-check-label text-info" for="checkCritic">Krytycy</label>
                            </div>

                            @* 2. GRACZE IGDB *@
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="checkUser" name="showUser" value="true" @(Model.ShowIgdbUser ? "checked" : "") onchange="this.form.submit()">
                                <label class="form-check-label text-primary" for="checkUser">Gracze</label>
                            </div>

                            @* 3. LOKALNI (GAMEHUB) *@
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="checkLocal" name="showLocal" value="true" @(Model.ShowLocal ? "checked" : "") onchange="this.form.submit()">
                                <label class="form-check-label text-warning" for="checkLocal">GameHub</label>
                            </div>
                        </div>
                    </div>

                    @* Ukryty input, aby resetować paginację przy zmianie filtrów *@
                    <input type="hidden" name="page" value="1" />
                </form>
            </div>
        </div>
    }

    <div class="row">
        @if (Model.Games.Any())
        {
            @foreach (var game in Model.Games)
            {
                @* --- ZMIANA TUTAJ: Klasy Bootstrap dla układu 2 -> 4 -> 6 --- *@
                <div class="col-6 col-md-3 col-xl-2 mb-4">

                    @if (Model.Mode == "guides")
                    {
                        <a asp-controller="Guides" asp-action="Index" asp-route-gameId="@game.Id" class="text-decoration-none text-dark card-link-wrapper">
                            @RenderGameCard(game)
                        </a>
                    }
                    else
                    {
                        <a asp-controller="Games" asp-action="Details" asp-route-id="@game.Id" class="text-decoration-none text-dark card-link-wrapper">
                            @RenderGameCard(game)
                        </a>
                    }
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="fas fa-search me-2"></i> Nie znaleziono gier pasujących do kryteriów. Spróbuj zmienić filtry lub frazę wyszukiwania.
                </div>
            </div>
        }
    </div>

    @* PAGINACJA *@
    <nav aria-label="Paginacja">
        <ul class="pagination justify-content-center">
            @{
                var prevDisabled = Model.CurrentPage > 1 ? "" : "disabled";
                var nextDisabled = Model.Games.Count == 50 ? "" : "disabled";

                // Helper do generowania URL z parametrami - DODANO isFiltered
                string GetPageUrl(int pageNum) => Url.Action("Index", new
                {
                    page = pageNum,
                    searchString = Model.SearchString,
                    mode = Model.Mode,
                    isFiltered = true, // Ważne! Żeby zachować stan filtrów
                    showUser = Model.ShowIgdbUser,
                    showCritic = Model.ShowIgdbCritic,
                    showLocal = Model.ShowLocal
                });
            }

            <li class="page-item @prevDisabled">
                <a class="page-link" href="@GetPageUrl(Model.CurrentPage - 1)">Poprzednia</a>
            </li>

            <li class="page-item active">
                <span class="page-link">@Model.CurrentPage</span>
            </li>

            <li class="page-item @nextDisabled">
                <a class="page-link" href="@GetPageUrl(Model.CurrentPage + 1)">Następna</a>
            </li>
        </ul>
    </nav>
</div>

@* Funkcja pomocnicza do renderowania wnętrza karty *@
@{
    Microsoft.AspNetCore.Html.IHtmlContent RenderGameCard(dynamic game)
    {
        <div class="card h-100 shadow-sm grow-on-hover" style="transition: transform 0.2s; border: none;">
            <div style="position: relative; padding-top: 150%; overflow: hidden; background-color: #1b2838; border-radius: 5px;">
                <img src="@(game.Cover?.Url ?? "https://via.placeholder.com/264x352.png?text=Brak+okładki")"
                     class="card-img-top"
                     style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;"
                     alt="@game.Name">

                @if (game.Total_rating != null && game.Total_rating > 0)
                {
                    double rating = (double)game.Total_rating;
                    string badgeColor = rating >= 75 ? "bg-success" : (rating >= 50 ? "bg-warning text-dark" : "bg-danger");

                    <div class="position-absolute top-0 end-0 m-2 badge @badgeColor shadow" style="font-size: 0.9rem;">
                        @rating.ToString("0")
                    </div>
                }
            </div>

            <div class="card-body p-2">
                <h6 class="card-title text-truncate font-weight-bold mt-2" title="@game.Name" style="margin-bottom: 0.2rem; font-size: 0.9rem;">
                    @game.Name
                </h6>
            </div>
        </div>
        return Html.Raw("");
    }
}

<style>
    .grow-on-hover:hover {
        transform: scale(1.05);
        cursor: pointer;
        z-index: 10;
        box-shadow: 0 1rem 3rem rgba(0,0,0,.2) !important;
    }

    .card-link-wrapper:hover {
        text-decoration: none;
        color: inherit;
    }
    /* Styl dla checkboxów switch */
    .form-check-input:checked {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }
</style>