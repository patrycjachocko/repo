@using Microsoft.AspNetCore.Identity
@using praca_dyplomowa_zesp.Models.Users

@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager

<ul class="navbar-nav align-items-center">
    @if (SignInManager.IsSignedIn(User))
    {
        var user = await UserManager.GetUserAsync(User);
        if (user != null)
        {
            var isAdmin = await UserManager.IsInRoleAsync(user, "Admin");
            var isMod = await UserManager.IsInRoleAsync(user, "Moderator");

            // Logika koloru ramki avatara (korzystamy ze zmiennych CSS)
            string borderColor = "var(--neon-cyan)"; // Domyślny user
            if (isAdmin) { borderColor = "var(--neon-pink)"; } // Admin (czerwony/róż)
            else if (isMod) { borderColor = "var(--neon-green)"; } // Mod (zielony)

            bool hasSteam = !string.IsNullOrEmpty(user.SteamId);

            @* --- 1. PANEL ZARZĄDZANIA (Tylko ikony dla oszczędności miejsca) --- *@
            @if (isAdmin)
            {
                <li class="nav-item me-2 d-none d-lg-block">
                    <a class="nav-link" asp-controller="Admin" asp-action="Index" title="Panel Admina" style="color: var(--neon-pink) !important;">
                        <i class="fas fa-user-shield"></i> <span class="d-none d-xl-inline ms-1" style="font-size: 0.8rem;">ADMIN</span>
                    </a>
                </li>
            }
            else if (isMod)
            {
                <li class="nav-item me-2 d-none d-lg-block">
                    <a class="nav-link" asp-controller="Admin" asp-action="Index" title="Panel Moderatora" style="color: var(--neon-green) !important;">
                        <i class="fas fa-user-check"></i> <span class="d-none d-xl-inline ms-1" style="font-size: 0.8rem;">MOD</span>
                    </a>
                </li>
            }

            @* --- 2. PRZYCISK "POŁĄCZ STEAM" (Jeśli brak) --- *@
            @if (!hasSteam)
            {
                <li class="nav-item me-3 d-none d-md-block">
                    <a asp-controller="Profile" asp-action="Index" class="btn btn-sm btn-secondary" title="Połącz Steam" style="padding: 5px 15px; font-size: 0.7rem;">
                        <i class="bi bi-steam"></i> POŁĄCZ
                    </a>
                </li>
            }

            @* --- 3. DROPDOWN UŻYTKOWNIKA --- *@
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    @* AVATAR *@
                    <div style="position: relative;">
                        @if (user.ProfilePicture != null)
                        {
                            <img src="@Url.Action("GetAvatar", "Profile", new { id = user.Id })" alt="Avatar"
                                 class="rounded-circle"
                                 style="width: 35px; height: 35px; object-fit: cover; border: 2px solid @borderColor; box-shadow: 0 0 10px @borderColor;" />
                        }
                        else
                        {
                            <img src="~/uploads/avatars/default_avatar.png" alt="Avatar"
                                 class="rounded-circle"
                                 style="width: 35px; height: 35px; object-fit: cover; border: 2px solid @borderColor; box-shadow: 0 0 10px @borderColor;" />
                        }
                    </div>
                    <span class="d-none d-sm-block text-uppercase" style="font-family: 'Rajdhani', sans-serif; font-weight: 700; letter-spacing: 1px;">
                        @user.UserName
                    </span>
                </a>

                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark" aria-labelledby="userDropdown">

                    @* HEADER *@
                    <li>
                        <div class="px-3 py-2">
                            <small class="text-muted d-block text-uppercase" style="font-size: 0.65rem; letter-spacing: 1px;">Zalogowano jako</small>
                            <span class="fw-bold text-white" style="font-family: 'Orbitron', sans-serif;">@user.UserName</span>
                        </div>
                    </li>
                    <li><hr class="dropdown-divider"></li>

                    @* OPCJE *@
                    <li>
                        <a class="dropdown-item" asp-controller="Profile" asp-action="Index">
                            <i class="bi bi-person-circle me-2 text-primary"></i> Mój Profil
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" asp-controller="Library" asp-action="Index">
                            <i class="bi bi-collection-play me-2 text-success"></i> Moja Biblioteka
                        </a>
                    </li>

                    @if (hasSteam)
                    {
                        <li>
                            <a class="dropdown-item" asp-controller="Profile" asp-action="SteamLibrary" style="color: var(--neon-cyan) !important;">
                                <i class="bi bi-steam me-2"></i> Biblioteka Steam
                            </a>
                        </li>
                    }

                    <li><hr class="dropdown-divider"></li>

                    <li>
                        <a class="dropdown-item" asp-controller="Tickets" asp-action="Index">
                            <i class="fas fa-headset me-2 text-muted"></i> Zgłoś problem
                        </a>
                    </li>

                    <li><hr class="dropdown-divider"></li>

                    @* WYLOGUJ *@
                    <li>
                        <form class="form-inline" asp-controller="Account" asp-action="Logout" asp-route-returnUrl="@Context.Request.Path@Context.Request.QueryString">
                            <button type="submit" class="dropdown-item text-danger fw-bold">
                                <i class="bi bi-box-arrow-right me-2"></i> WYLOGUJ
                            </button>
                        </form>
                    </li>
                </ul>
            </li>
        }
    }
    else
    {
        @* --- 4. NIEZALOGOWANY (Czysto i nowocześnie) --- *@

        <li class="nav-item">
            <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">
                ZALOGUJ
            </a>
        </li>
        <li class="nav-item ms-2">
            @* Używamy klasy .btn-primary z Twojego site.css - fioletowy, hollow neon *@
            <a class="btn btn-sm btn-primary" href="#" data-bs-toggle="modal" data-bs-target="#registerModal" style="padding: 6px 20px;">
                <i class="bi bi-person-plus me-1"></i> REJESTRACJA
            </a>
        </li>
    }
</ul>