@using praca_dyplomowa_zesp.Models.Modules.Libraries.UserLibrary
@model GameInLibraryViewModel

@{
    ViewData["Title"] = Model.Name;
}

<style>
    /* Klasa do wyszarzania niezdobytych osiągnięć */
    .achievement-icon {
        width: 64px;
        height: 64px;
        margin-right: 15px;
        transition: filter 0.3s ease;
    }

        .achievement-icon.locked {
            filter: grayscale(100%) opacity(0.6);
        }

        .achievement-icon.unlocked {
            filter: grayscale(0%);
        }
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {
        $('.achievement-checkbox').change(function () {
            var gameId = @Model.IgdbGameId;
            var achievementId = $(this).data('external-id');
            var isChecked = $(this).is(':checked');
            var imgElement = $('#img-' + achievementId.replace(/[^a-zA-Z0-9]/g, '_'));

            $.ajax({
                url: '@Url.Action("ToggleAchievement", "Library")',
                type: 'POST',
                data: {
                    igdbGameId: gameId,
                    achievementExternalId: achievementId
                },
                headers: {
                    RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        // Aktualizuj wizualnie obrazek
                        if (response.isUnlocked) {
                            imgElement.removeClass('locked').addClass('unlocked');
                        } else {
                            imgElement.removeClass('unlocked').addClass('locked');
                        }
                    } else {
                        alert(response.error || 'Wystąpił błąd');
                        $(this).prop('checked', !isChecked);
                    }
                },
                error: function () {
                    alert('Błąd komunikacji z serwerem.');
                    $(this).prop('checked', !isChecked);
                }
            });
        });
    });
</script>

<div class="row">
    <div class="col-md-4">
        <img src="@(Model.CoverUrl ?? "https://via.placeholder.com/264x352.png?text=Brak+okładki")" class="img-fluid rounded mb-3" alt="Okładka @Model.Name">

        <h4>Postęp Fabularny</h4>
        <p class="mb-1">
            <strong>Obecna misja:</strong>
        </p>
        <p class="text-muted">
            @(Model.CurrentUserStoryMission ?? "Nie ustawiono")
        </p>

        <p class="mb-1">
            <strong>Postęp (%):</strong>
        </p>
        <div class="progress mb-3" style="height: 20px;">
            <div class="progress-bar" role="progressbar" style="width: @Model.CurrentUserStoryProgressPercent%;"
                 aria-valuenow="@Model.CurrentUserStoryProgressPercent" aria-valuemin="0" aria-valuemax="100">
                @Model.CurrentUserStoryProgressPercent%
            </div>
        </div>

        <h4>Notatki</h4>
        <div class="notes-display bg-light p-3 rounded" style="min-height: 100px; white-space: pre-wrap; border: 1px solid #ddd;">
            @(Model.Notes ?? "Brak notatek.")
        </div>

    </div>

    <div class="col-md-8">
        <h1>@Model.Name</h1>
        <hr />

        <div class="mb-3">
            <a asp-controller="Guides" asp-action="Index" asp-route-gameId="@Model.IgdbGameId" class="btn btn-outline-info">
                Przejdź do Poradników i Wskazówek
            </a>
            <a asp-action="Edit" asp-route-id="@Model.DbId" class="btn btn-secondary">Edytuj Postęp i Notatki</a>
            <a asp-action="Delete" asp-route-id="@Model.DbId" class="btn btn-danger">Usuń z biblioteki</a>
        </div>


        <dl class="row">
            <dt class="col-sm-3">Deweloper</dt>
            <dd class="col-sm-9">@(Model.Developer ?? "Nieznany")</dd>

            <dt class="col-sm-3">Data wydania</dt>
            <dd class="col-sm-9">@(Model.ReleaseDate ?? "Nieznana")</dd>

            <dt class="col-sm-3">Data dodania</dt>
            <dd class="col-sm-9">@Model.DateAddedToLibrary.ToString("dd.MM.yyyy")</dd>

            <dt class="col-sm-3">Gatunki</dt>
            <dd class="col-sm-9">
                @if (Model.Genres != null && Model.Genres.Any())
                {
                    @string.Join(", ", Model.Genres)
                }
                else
                {
                    <span>Nieznane</span>
                }
            </dd>
        </dl>

        <hr />

        <h3>Osiągnięcia</h3>

        @if (Model.IsSteamGame && !Model.IsSteamConnected)
        {
            <div class="alert alert-warning d-flex align-items-center" role="alert">
                <i class="bi bi-steam me-2" style="font-size: 1.5rem;"></i>
                <div>
                    <strong>Chcesz automatycznie śledzić osiągnięcia?</strong><br />
                    Ta gra obsługuje osiągnięcia Steam. Połącz swoje konto, aby zaimportować postępy.
                    <br />
                    <a asp-controller="Profile" asp-action="Index" class="btn btn-sm btn-dark mt-2">
                        Połącz konto Steam w Profilu
                    </a>
                </div>
            </div>
        }

        @if (Model.Achievements != null && Model.Achievements.Any())
        {
            <form>
                @Html.AntiForgeryToken()
                <ul class="list-group">
                    @foreach (var ach in Model.Achievements)
                    {
                        // Bezpieczne ID dla elementu HTML (usuwamy znaki specjalne z ApiName)
                        var safeId = ach.ExternalId.Replace(" ", "_").Replace(".", "_");

                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <img src="@ach.IconUrl"
                                     alt="Ikona"
                                     id="img-@safeId"
                                     class="achievement-icon rounded @(ach.IsUnlocked ? "unlocked" : "locked")">
                                <div>
                                    <strong>@ach.Name</strong>
                                    <p class="mb-0 text-muted" style="font-size: 0.9rem;">@ach.Description</p>
                                </div>
                            </div>

                            @if (!Model.IsSteamConnected)
                            {
                                @* Pozwalamy klikać tylko jeśli NIE ma Steam (manualny tryb) *@
                                <div class="form-check form-switch">
                                    <input class="form-check-input achievement-checkbox"
                                           type="checkbox"
                                           role="switch"
                                           id="ach-@ach.ExternalId"
                                           data-external-id="@ach.ExternalId"
                                    @(ach.IsUnlocked ? "checked" : "")>
                                    <label class="form-check-label" for="ach-@ach.ExternalId">
                                        @(ach.IsUnlocked ? "Odblokowane" : "Zablokowane")
                                    </label>
                                </div>
                            }
                            else
                            {
                                @* Jeśli Steam podłączony, tylko wyświetlamy status *@
                                <span class="badge @(ach.IsUnlocked ? "bg-success" : "bg-secondary")">
                                    @(ach.IsUnlocked ? "Zdobyte (Steam)" : "Zablokowane")
                                </span>
                            }
                        </li>
                    }
                </ul>
            </form>
        }
        else
        {
            <p>Brak dostępnych osiągnięć do śledzenia dla tej gry.</p>
        }
    </div>
</div>