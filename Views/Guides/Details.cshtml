@using praca_dyplomowa_zesp.Models.Interactions.Reactions
@using System.Security.Claims
@model praca_dyplomowa_zesp.Models.Modules.Guides.GuideDetailsViewModel

@{
    ViewData["Title"] = Model.Guide.Title;

    Guid currentUserId = Guid.Empty;
    if (User.Identity.IsAuthenticated)
    {
        var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (userIdClaim != null)
        {
            Guid.TryParse(userIdClaim, out currentUserId);
        }
    }

    bool isAuthor = User.Identity.IsAuthenticated && Model.Guide.User?.UserName == User.Identity.Name;
    bool isAdminOrMod = User.IsInRole("Admin") || User.IsInRole("Moderator");

    // --- LOGIKA STATUSÓW ---
    bool isRejected = Model.Guide.IsRejected;
    bool isDraft = Model.Guide.IsDraft;
    bool isDeleted = Model.Guide.IsDeleted;
    bool isPending = !Model.Guide.IsApproved && !isDeleted && !isDraft && !isRejected;
    bool isApproved = Model.Guide.IsApproved && !isDeleted;

    // Klasy CSS statusów
    string statusBorderClass = "status-border-approved";
    string statusLabel = "OPUBLIKOWANY";
    string statusBtnColor = "var(--neon-purple)";

    if (isDeleted)
    {
        statusBorderClass = "status-border-deleted";
        statusLabel = "USUNIĘTY / KOSZ";
        statusBtnColor = "var(--neon-red)";
    }
    else if (isDraft)
    {
        statusBorderClass = "status-border-draft";
        statusLabel = "SZKIC ROBOCZY";
        statusBtnColor = "var(--neon-grey)";
    }
    else if (isRejected)
    {
        statusBorderClass = "status-border-rejected";
        statusLabel = "DO POPRAWY";
        statusBtnColor = "var(--neon-orange)";
    }
    else if (isPending)
    {
        statusBorderClass = "status-border-pending";
        statusLabel = "OCZEKUJE NA AKCEPTACJĘ";
        statusBtnColor = "var(--neon-yellow)";
    }

    // Tło nagłówka
    string bgImageUrl = Model.Guide.CoverImage != null
        ? $"data:{Model.Guide.CoverImageContentType};base64,{Convert.ToBase64String(Model.Guide.CoverImage)}"
        : "";

    // Helper funkcji kolorów (lokalny)
    string GetRoleColor(string role)
    {
        var r = role?.ToLower() ?? "user";
        if (r == "admin") return "var(--neon-red)";
        if (r == "moderator") return "var(--neon-green)";
        return "var(--neon-cyan)";
    }
}

<div class="container mt-4 main-container fade-in-up">

    @* --- KOMUNIKATY --- *@
    @if (TempData["StatusMessage"] != null)
    {
        <div class="alert alert-neon alert-neon-success alert-dismissible fade show mb-4" role="alert">
            <i class="fas fa-check-circle me-2"></i> @TempData["StatusMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-neon alert-neon-danger alert-dismissible fade show mb-4" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i> @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @* --- NAWIGACJA GÓRNA --- *@
    <div class="d-flex justify-content-between align-items-center position-relative mb-4">
        <div>
            <a asp-action="Index" asp-route-gameId="@Model.Guide.IgdbGameId" class="btn btn-neon-cyan btn-sm px-4">
                <i class="fas fa-arrow-left me-2"></i> POWRÓT DO BAZY
            </a>
        </div>

        @if (isAuthor || isAdminOrMod)
        {
            <div class="position-absolute start-50 translate-middle-x">
                <span class="btn btn-sm btn-static rounded-pill" style="border-color: @statusBtnColor; color: @statusBtnColor;">
                    STATUS: @statusLabel
                </span>
            </div>
        }

        <div>
            @if (!isDraft)
            {
                <a asp-action="DownloadPdf" asp-route-id="@Model.Guide.Id" class="btn btn-danger-custom btn-sm px-4" target="_blank">
                    PDF
                </a>
            }
        </div>
    </div>

    @* --- ALERT ODRZUCENIA --- *@
    @if (isRejected)
    {
        <div class="alert alert-neon alert-neon-danger mb-4" style="--alert-color: var(--neon-orange); border-left-color: var(--neon-orange);">
            <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-circle fa-2x me-3" style="color: var(--neon-orange);"></i>
                <div>
                    <h5 class="fw-bold text-uppercase mb-1" style="color: var(--neon-orange);">Wymagana Poprawa</h5>
                    <div class="system-log-panel bg-transparent border-0 p-0">
                        <span class="text-light fst-italic">"@Model.Guide.RejectionReason"</span>
                    </div>
                </div>
            </div>
        </div>
    }

    @* =========================================================================
       1. NAGŁÓWEK (Tytuł, Autor, Oceny, Data)
       ========================================================================= *@
    <div class="guide-panel-base guide-split-header @statusBorderClass">

        <div class="guide-header-bg" style="background-image: url('@bgImageUrl');"></div>
        <div class="header-overlay"></div>

        <div class="guide-header-content w-100">
            @* Tytuł *@
            <h1 class="game-details-title mb-4 text-center">@Model.Guide.Title</h1>

            @* Pasek informacji *@
            <div class="guide-info-bar">
                <div class="info-item">
                    @{
                        string roleColor = GetRoleColor(Model.Guide.User?.Role);
                    }
                    <i class="fas fa-user-edit me-2"></i>
                    <span style="color: @roleColor; text-shadow: 0 0 5px @roleColor;">
                        @(Model.Guide.User?.UserName ?? "Użytkownik")
                    </span>
                </div>

                @if (isApproved)
                {
                    <div class="info-separator">•</div>
                    <div class="info-item" style="color: var(--neon-purple); text-shadow: 0 0 8px var(--neon-purple); font-weight: 700;">
                        <i class="fas fa-star me-2"></i> @Model.AverageRating.ToString("0.0") / 5.0
                    </div>
                }

                <div class="info-separator">•</div>
                <div class="info-item">
                    <i class="far fa-calendar-alt me-2"></i> @Model.Guide.CreatedAt.ToString("dd.MM.yyyy")
                </div>
            </div>

            @* Wstęp (Description) *@
            @if (!string.IsNullOrEmpty(Model.Guide.Description))
            {
                <div class="guide-intro-text">
                    "@Model.Guide.Description"
                </div>
            }
        </div>
    </div>

    @* =========================================================================
       2. TREŚĆ (Body)
       ========================================================================= *@
    <div class="guide-panel-base guide-split-content @statusBorderClass">
        <div class="guide-content-body">
            @if (!string.IsNullOrEmpty(Model.Guide.Content))
            {
                @Html.Raw(Model.Guide.Content)
            }
            else
            {
                <div class="text-center text-muted py-5">
                    <i class="fas fa-terminal fa-3x mb-3 opacity-25"></i>
                    <p>Inicjalizacja treści nieudana: Brak danych</p>
                </div>
            }
        </div>

        @* Akcje *@
        @if ((!isDeleted && (isAuthor || isAdminOrMod)) || (isDeleted && isAdminOrMod))
        {
            <div class="guide-action-footer" style="justify-content: center; gap: 15px;">
                <a asp-action="Edit" asp-route-id="@Model.Guide.Id" class="btn btn-neon-yellow btn-sm px-4">
                    EDYTUJ TREŚĆ
                </a>

                @if (isDeleted)
                {
                    <form asp-controller="Admin" asp-action="RestoreGuide" method="post" class="d-inline">
                        <input type="hidden" name="id" value="@Model.Guide.Id" />
                        <button type="submit" class="btn btn-neon-green btn-sm px-4">PRZYWRÓĆ</button>
                    </form>

                    <form asp-controller="Admin" asp-action="DeleteGuidePermanently" method="post" class="d-inline">
                        <input type="hidden" name="id" value="@Model.Guide.Id" />
                        <button type="submit" class="btn btn-danger-custom btn-sm px-4" onclick="return confirm('UWAGA: Czy na pewno chcesz trwale usunąć ten poradnik? Tej operacji nie można cofnąć.')">
                            USUŃ NA STAŁE
                        </button>
                    </form>
                }
                else
                {
                    <button class="btn btn-danger-custom btn-sm px-4" onclick="return confirm('Przenieść do kosza?')">USUŃ</button>
                }
            </div>
        }
    </div>

    @* --- MODERACJA --- *@
    @if (isPending && isAdminOrMod)
    {
        <div class="glass-panel border-warning p-4 mb-5 text-center" style="border-color: var(--neon-yellow) !important; box-shadow: 0 0 20px color-mix(in srgb, var(--neon-yellow) 15%, transparent) !important;">
            <h4 class="text-neon-warning mb-3">Decyzja Moderacji</h4>
            <div class="d-flex justify-content-center gap-3">
                <form asp-controller="Guides" asp-action="ApproveGuide" method="post">
                    <input type="hidden" name="id" value="@Model.Guide.Id" />
                    <button type="submit" class="btn btn-neon-green px-5">ZATWIERDŹ</button>
                </form>
                <button type="button" class="btn btn-danger-custom px-5" data-bs-toggle="modal" data-bs-target="#rejectModal">ODRZUĆ</button>
            </div>
        </div>
    }

    @* --- INTERAKCJE (OCENY) --- *@
    @if (isApproved)
    {
        <div class="glass-panel text-center p-4 mb-5 d-flex flex-column justify-content-center align-items-center position-relative" style="min-height: 120px;">

            @if (User.Identity.IsAuthenticated)
            {
                @Html.AntiForgeryToken()
                <input type="hidden" id="guideId" value="@Model.Guide.Id" />
                <input type="hidden" id="currentRating" value="@Model.UserRating" />

                <div class="d-flex justify-content-center align-items-center gap-3">

                    <span class="text-uppercase fw-bold" style="font-size: 1.2rem; letter-spacing: 2px; color: var(--white); text-shadow: 0 0 10px rgba(255,255,255,0.5);">
                        TWOJA OCENA:
                    </span>

                    <div id="star-container" class="d-flex gap-1" style="font-size: 2.2rem; cursor: pointer; line-height: 1;">
                        <i class="far fa-star guide-star-custom" data-value="1"></i>
                        <i class="far fa-star guide-star-custom" data-value="2"></i>
                        <i class="far fa-star guide-star-custom" data-value="3"></i>
                        <i class="far fa-star guide-star-custom" data-value="4"></i>
                        <i class="far fa-star guide-star-custom" data-value="5"></i>
                    </div>

                    <div class="text-white fw-bold d-flex align-items-baseline" style="font-size: 1.8rem; line-height: 1;">
                        <span id="rating-display" style="text-shadow: 0 0 10px var(--neon-purple);">@Model.UserRating.ToString("0.0")</span>
                        <span style="font-size: 1rem; color: #aaa; margin-left: 5px;">/ 5.0</span>
                    </div>

                </div>

                <div id="save-message" class="text-neon-green small opacity-0 transition-opacity position-absolute" style="bottom: 15px;">
                    <i class="bi bi-check-lg"></i> DANE ZAPISANE
                </div>
            }
            else
            {
                <p class="text-muted small m-0">Zaloguj się, aby przesłać dane oceny.</p>
            }
        </div>

        @* --- JEDNOLITY PANEL KOMENTARZY --- *@
        <div class="guide-panel-base guide-split-content @statusBorderClass mb-5" id="comments" style="border-width: 1px !important;">
            <div class="p-2">
                <h4 class="text-neon-title fs-4 mb-4 pb-0" style="letter-spacing: 1px;">
                    Komentarze <span class="text-muted fs-6">(@Model.Comments.Count)</span>
                </h4>

                @if (User.Identity.IsAuthenticated)
                {
                    <div class="mb-4">
                        <form asp-action="AddComment" method="post">
                            <input type="hidden" name="guideId" value="@Model.Guide.Id" />
                            <div class="chat-input-merged" style="border-width: 1px !important;">
                                <div class="form-floating flex-grow-1">
                                    <textarea name="content" class="form-control" style="height: 55px; resize: none; overflow: hidden; background: transparent !important; border: none; color: white;" placeholder="..." required></textarea>
                                    <label style="color: var(--text-muted);">Dodaj komentarz...</label>
                                </div>
                                <button type="submit" class="btn-send-integrated">
                                    <i class="fas fa-paper-plane"></i> WYŚLIJ
                                </button>
                            </div>
                        </form>
                    </div>
                }

                @if (Model.Comments.Any())
                {
                    <div class="d-flex flex-column gap-3">
                        @foreach (var comment in Model.Comments)
                        {
                            var isCommentAuthor = User.Identity.IsAuthenticated && comment.Author.UserName == User.Identity.Name;
                            var canManageComment = isCommentAuthor || isAdminOrMod;
                            var userLikedComment = comment.Reactions.Any(r => r.UserId == currentUserId && r.Type == ReactionType.Like);
                            var userDislikedComment = comment.Reactions.Any(r => r.UserId == currentUserId && r.Type == ReactionType.Dislike);
                            var commentScore = comment.Reactions.Count(r => r.Type == ReactionType.Like) - comment.Reactions.Count(r => r.Type == ReactionType.Dislike);

                            string mainRoleColor = GetRoleColor(comment.Author?.Role);

                            // --- LOGIKA AVATARA ---
                            string avatarUrl;
                            if (comment.Author?.ProfilePicture != null)
                            {
                                // Użytkownik ma własny avatar w bazie -> Pobieramy z kontrolera
                                // Dodajemy ?v=Ticks, aby wymusić odświeżenie obrazka po zmianie (omija cache przeglądarki)
                                avatarUrl = Url.Action("GetAvatar", "Profile", new { id = comment.Author.Id }) + "?v=" + DateTime.Now.Ticks;
                            }
                            else
                            {
                                // Użytkownik nie ma avatara w bazie -> Wskazujemy na plik domyślny w wwwroot
                                avatarUrl = "/uploads/avatars/default_avatar.png";
                            }

                            <div class="p-3 rounded" style="background-color: rgba(0,0,0,0.3); border: 1px solid var(--border-tech);">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center gap-3">

                                        @* Wyświetlanie avatara (Baza lub Plik domyślny) *@
                                        <img src="@avatarUrl"
                                             class="rounded-circle"
                                             alt="@comment.Author?.UserName"
                                             style="width: 40px; height: 40px; object-fit: cover; border: 2px solid @mainRoleColor; box-shadow: 0 0 10px color-mix(in srgb, @mainRoleColor 30%, transparent);"
                                             onerror="this.src='/uploads/avatars/default_avatar.png'" />

                                        <div>
                                            <div class="fw-bold" style="color: @mainRoleColor; text-shadow: 0 0 5px @mainRoleColor;">
                                                @comment.Author?.UserName
                                            </div>
                                            <div class="text-muted" style="font-size: 0.7rem;">@comment.CreatedAt.ToString("g")</div>
                                        </div>
                                    </div>

                                    @if (canManageComment)
                                    {
                                        <div class="dropdown">
                                            <button class="btn btn-icon-square text-muted" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v"></i></button>
                                            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end custom-drop">
                                                @if (isCommentAuthor)
                                                {
                                                    <li><a class="dropdown-item" href="#" onclick="toggleEditForm('comment-edit-@comment.Id'); return false;">Edytuj</a></li>
                                                }
                                                <li>
                                                    <form asp-action="DeleteComment" method="post">
                                                        <input type="hidden" name="commentId" value="@comment.Id" />
                                                        <input type="hidden" name="guideId" value="@Model.Guide.Id" />
                                                        <button type="submit" class="dropdown-item text-danger">Usuń</button>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>
                                    }
                                </div>

                                <div id="comment-content-@comment.Id" class="mb-3 ps-1 text-light" style="white-space: pre-wrap; font-size: 0.95rem; line-height: 1.5;">@comment.Content</div>

                                <div id="comment-edit-@comment.Id" class="d-none mb-3">
                                    <form asp-action="EditComment" method="post">
                                        <input type="hidden" name="commentId" value="@comment.Id" />
                                        <input type="hidden" name="guideId" value="@Model.Guide.Id" />
                                        <div class="chat-input-merged" style="border-width: 1px !important; height: 50px;">
                                            <div class="form-floating flex-grow-1">
                                                <input type="text" name="content" value="@comment.Content" class="form-control" style="height: 50px; background: transparent; border: none; color: white;" placeholder="..." required>
                                                <label style="color: var(--text-muted); padding-top: 0.6rem;">Edytuj treść...</label>
                                            </div>
                                            <button class="btn-send-integrated" type="submit" style="height: 50px;">ZAPISZ</button>
                                        </div>
                                    </form>
                                </div>

                                <div class="d-flex align-items-center gap-3">
                                    <div class="d-flex align-items-center gap-2">
                                        <form asp-action="ToggleReaction" method="post" class="d-inline">
                                            <input type="hidden" name="commentId" value="@comment.Id" />
                                            <input type="hidden" name="guideId" value="@Model.Guide.Id" />
                                            <input type="hidden" name="isUpvote" value="true" />
                                            <button class="btn-vote vote-up @(userLikedComment ? "active" : "")" style="width:30px; height:30px;"><i class="fas fa-thumbs-up"></i></button>
                                        </form>
                                        <span class="fw-bold small @(commentScore > 0 ? "text-neon-green" : commentScore < 0 ? "text-neon-red" : "text-muted")">@commentScore</span>
                                        <form asp-action="ToggleReaction" method="post" class="d-inline">
                                            <input type="hidden" name="commentId" value="@comment.Id" />
                                            <input type="hidden" name="guideId" value="@Model.Guide.Id" />
                                            <input type="hidden" name="isUpvote" value="false" />
                                            <button class="btn-vote vote-down @(userDislikedComment ? "active" : "")" style="width:30px; height:30px;"><i class="fas fa-thumbs-down"></i></button>
                                        </form>
                                    </div>
                                    @if (User.Identity.IsAuthenticated)
                                    {
                                        <button class="btn btn-link btn-sm text-muted p-0 text-decoration-none" onclick="document.getElementById('reply-form-@comment.Id').classList.toggle('d-none')">
                                            <i class="fas fa-reply me-1"></i> ODPOWIEDZ
                                        </button>
                                    }
                                </div>

                                <div id="reply-form-@comment.Id" class="mt-3 d-none ps-3">
                                    <form asp-action="AddReply" method="post">
                                        <input type="hidden" name="commentId" value="@comment.Id" />
                                        <input type="hidden" name="guideId" value="@Model.Guide.Id" />
                                        <div class="chat-input-merged" style="height: 45px; border-width: 1px !important;">
                                            <div class="form-floating flex-grow-1">
                                                <input type="text" name="content" class="form-control" style="height: 45px; background: transparent; border: none; color: white;" placeholder="..." required>
                                                <label style="color: var(--text-muted); padding-top: 0.6rem;">Odpowiedź...</label>
                                            </div>
                                            <button class="btn-send-integrated" type="submit" style="height: 45px;"><i class="fas fa-paper-plane"></i></button>
                                        </div>
                                    </form>
                                </div>

                                @if (comment.Replies != null && comment.Replies.Any())
                                {
                                    <div class="reply-thread mt-3 ps-3" style="border-left: none !important;">
                                        @foreach (var reply in comment.Replies)
                                        {
                                            var isReplyAuthor = User.Identity.IsAuthenticated && reply.Author.UserName == User.Identity.Name;
                                            var canManageReply = isReplyAuthor || isAdminOrMod;
                                            string replyRoleColor = GetRoleColor(reply.Author?.Role);

                                            <div class="reply-box mt-2 p-3 rounded position-relative"
                                                 style="background-color: rgba(255, 255, 255, 0.03); border-left: 3px solid @replyRoleColor;">

                                                <div class="d-flex justify-content-between align-items-start mb-1">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <span class="fw-bold small" style="color: @replyRoleColor; text-shadow: 0 0 5px @replyRoleColor;">
                                                            @reply.Author.UserName
                                                        </span>
                                                        <span class="text-muted" style="font-size: 0.65rem;">@reply.CreatedAt.ToString("dd.MM HH:mm")</span>
                                                    </div>

                                                    @if (canManageReply)
                                                    {
                                                        <div class="dropdown">
                                                            <button class="btn btn-sm text-muted p-0" style="line-height: 1;" data-bs-toggle="dropdown"><i class="fas fa-ellipsis-v" style="font-size: 0.8rem;"></i></button>
                                                            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end custom-drop" style="min-width: 120px;">
                                                                @if (isReplyAuthor)
                                                                {
                                                                    <li><a class="dropdown-item small" href="#" onclick="toggleEditForm('reply-edit-@reply.Id'); return false;">Edytuj</a></li>
                                                                }
                                                                <li>
                                                                    <form asp-action="DeleteReply" method="post">
                                                                        <input type="hidden" name="replyId" value="@reply.Id" />
                                                                        <input type="hidden" name="guideId" value="@Model.Guide.Id" />
                                                                        <button type="submit" class="dropdown-item small text-danger">Usuń</button>
                                                                    </form>
                                                                </li>
                                                            </ul>
                                                        </div>
                                                    }
                                                </div>

                                                <div id="comment-content-reply-@reply.Id" class="small text-white-50" style="white-space: pre-wrap;">@reply.Content</div>

                                                <div id="reply-edit-@reply.Id" class="d-none mt-2">
                                                    <form asp-action="EditReply" method="post">
                                                        <input type="hidden" name="replyId" value="@reply.Id" />
                                                        <input type="hidden" name="guideId" value="@Model.Guide.Id" />
                                                        <div class="chat-input-merged" style="border-width: 1px !important; height: 40px;">
                                                            <div class="form-floating flex-grow-1">
                                                                <input type="text" name="content" value="@reply.Content" class="form-control" style="height: 40px; background: transparent; border: none; color: white; font-size: 0.85rem;" placeholder="..." required>
                                                                <label style="color: var(--text-muted); padding-top: 0.4rem; font-size: 0.8rem;">Edytuj...</label>
                                                            </div>
                                                            <button class="btn-send-integrated" type="submit" style="height: 40px; padding: 0 15px; font-size: 0.8rem;">OK</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center text-muted py-4">Brak komentarzy. Bądź pierwszy!</div>
                }
            </div>
        </div>
    }
</div>

@* --- MODAL ODRZUCENIA --- *@
@if (isAdminOrMod)
{
    <div class="modal fade" id="rejectModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-neon modal-compact" style="border-color: var(--neon-purple); box-shadow: 0 0 20px color-mix(in srgb, var(--neon-purple) 20%, transparent);">
                <form asp-controller="Guides" asp-action="RejectGuide" method="post">
                    <div class="modal-header border-0 pb-0 justify-content-center">
                        <h5 class="modal-title text-uppercase fw-bold" style="color: var(--neon-purple); text-shadow: 0 0 10px var(--neon-purple);">
                            WSKAZÓWKI DO POPRAWY
                        </h5>
                        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="modal" style="filter: none; opacity: 0.8;"></button>
                    </div>

                    <div class="modal-body pt-3">
                        <input type="hidden" name="id" value="@Model.Guide.Id" />
                        <div class="form-floating">
                            <textarea class="form-control form-control-tech" name="reason" style="height: 150px; resize: none;" required></textarea>
                            <label>Wpisz powód odrzucenia / instrukcje...</label>
                        </div>
                    </div>

                    <div class="modal-footer border-0 justify-content-center pb-4">
                        <button type="button" class="btn btn-ghost-cancel px-4" data-bs-dismiss="modal">ANULUJ</button>
                        <button type="submit" class="btn btn-neon-primary px-4">POTWIERDŹ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

@section Scripts {
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    @* STYL LOKALNY: Gwiazdki + Żółty guzik *@
    <style>
        .guide-star-custom {
            transition: all 0.2s ease;
            color: rgba(255, 255, 255, 0.15); /* Domyślnie przezroczyste */
            text-shadow: none;
        }

            .guide-star-custom:hover {
                transform: scale(1.2);
            }

        /* Definicja żółtego przycisku */
        .btn-neon-yellow {
            border-color: var(--neon-yellow);
            color: var(--neon-yellow);
        }

            .btn-neon-yellow:hover {
                background: rgba(242, 255, 0, 0.1);
                box-shadow: inset 0 0 20px var(--neon-yellow);
                text-shadow: 0 0 8px var(--neon-yellow);
                color: #fff;
            }
    </style>

    <script>
        function toggleEditForm(id) {
            var form = document.getElementById(id);
            // Dla odpowiedzi ID ma format 'reply-edit-XX', dla komentarza 'comment-edit-XX'
            var contentId;
            if(id.startsWith('reply-edit-')) {
                contentId = id.replace('reply-edit-', 'comment-content-reply-');
            } else {
                contentId = id.replace('comment-edit-', 'comment-content-');
            }

            var contentDiv = document.getElementById(contentId);

            if (form.classList.contains('d-none')) {
                form.classList.remove('d-none');
                if(contentDiv) contentDiv.classList.add('d-none');
            } else {
                form.classList.add('d-none');
                if(contentDiv) contentDiv.classList.remove('d-none');
            }
        }

        // --- INTERAKTYWNA MAPA ---
        function fixUrl(url) {
            if (!url) return '';
            if (url.startsWith('http') || url.startsWith('data:')) return url;
            if (!url.startsWith('/')) return '/' + url;
            return url;
        }

        document.addEventListener("DOMContentLoaded", function() {
            var mapImages = document.querySelectorAll('img.interactive-map-source');
            mapImages.forEach(function(img) {
                var rawUrl = img.getAttribute('data-origin-src') || img.getAttribute('src');
                var imageUrl = fixUrl(rawUrl);
                var geoJsonRaw = img.getAttribute('data-geojson');
                if (!geoJsonRaw) return;

                var mapContainer = document.createElement('div');
                var mapId = 'map-' + Math.floor(Math.random() * 1000000);
                mapContainer.id = mapId;
                mapContainer.style.width = "100%";
                mapContainer.style.height = "500px";
                mapContainer.className = "shadow-lg border border-secondary mb-4 rounded";
                img.parentNode.replaceChild(mapContainer, img);

                var map = L.map(mapId, {
                    crs: L.CRS.Simple,
                    minZoom: -5, maxZoom: 4, zoomSnap: 0.25,
                    scrollWheelZoom: false
                });
                map.on('focus', () => { map.scrollWheelZoom.enable(); });
                map.on('blur', () => { map.scrollWheelZoom.disable(); });

                var imageObj = new Image();
                imageObj.src = imageUrl;
                imageObj.onload = function() {
                    var w = this.width;
                    var h = this.height;
                    var southWest = map.unproject([0, h], map.getMaxZoom() - 1);
                    var northEast = map.unproject([w, 0], map.getMaxZoom() - 1);
                    var bounds = new L.LatLngBounds(southWest, northEast);
                    L.imageOverlay(imageUrl, bounds).addTo(map);
                    map.fitBounds(bounds);
                    if (geoJsonRaw) {
                        try {
                            var geoJsonData = JSON.parse(geoJsonRaw);
                            L.geoJSON(geoJsonData, {
                                style: (f) => ({ color: f.properties?.color || '#00f3ff', weight: 4, fillOpacity: 0.4 }),
                                pointToLayer: (f, latlng) => L.circleMarker(latlng, { radius: 8, fillColor: f.properties?.color || '#dc3545', color: "#fff", weight: 2, fillOpacity: 0.8 }),
                                onEachFeature: (f, l) => { if (f.properties?.note) l.bindPopup(f.properties.note); }
                            }).addTo(map);
                        } catch (e) { console.error("GeoJSON Error:", e); }
                    }
                };
            });

            // --- SYSTEM OCENIANIA (BIAŁE GWIAZDKI Z NEONEM) ---
            const starContainer = document.getElementById('star-container');
            if (starContainer) {
                const stars = starContainer.querySelectorAll('.guide-star-custom');
                const display = document.getElementById('rating-display');
                const guideId = document.getElementById('guideId').value;
                const saveMessage = document.getElementById('save-message');
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

                let currentRatingStr = document.getElementById('currentRating').value;
                let currentRating = parseFloat(currentRatingStr.replace(',', '.'));
                if(isNaN(currentRating)) currentRating = 0;

                function renderStars(value) {
                    stars.forEach((star, index) => {
                        const starValue = index + 1;

                        star.className = 'far fa-star guide-star-custom';
                        star.style.color = 'rgba(255, 255, 255, 0.15)';
                        star.style.textShadow = 'none';

                        if (value >= starValue) {
                            star.className = 'fas fa-star guide-star-custom';
                            star.style.color = '#ffffff';
                            star.style.textShadow = '0 0 10px var(--neon-purple), 0 0 20px var(--neon-purple)';
                        }
                        else if (value >= starValue - 0.5) {
                            star.className = 'fas fa-star-half-alt guide-star-custom';
                            star.style.color = '#ffffff';
                            star.style.textShadow = '0 0 10px var(--neon-purple), 0 0 20px var(--neon-purple)';
                        }
                    });
                }

                renderStars(currentRating);

                stars.forEach((star, index) => {
                    star.addEventListener('mousemove', (e) => {
                        const rect = star.getBoundingClientRect();
                        const isLeftHalf = (e.clientX - rect.left) < (rect.width / 2);
                        let hoverValue = index + 1;
                        if (isLeftHalf) hoverValue -= 0.5;

                        renderStars(hoverValue);
                        if(display) display.innerText = hoverValue.toFixed(1);
                    });

                    star.addEventListener('click', (e) => {
                        const rect = star.getBoundingClientRect();
                        const isLeftHalf = (e.clientX - rect.left) < (rect.width / 2);
                        let selectedValue = index + 1;
                        if (isLeftHalf) selectedValue -= 0.5;

                        currentRating = selectedValue;
                        if(display) display.innerText = selectedValue.toFixed(1);
                        renderStars(currentRating);

                        fetch('/Guides/RateGuide', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                            body: JSON.stringify({ guideId: parseInt(guideId), ratingValue: selectedValue })
                        })
                        .then(r => r.json())
                        .then(d => {
                            if(d.success) {
                                saveMessage.style.opacity = '1';
                                setTimeout(() => saveMessage.style.opacity = '0', 2000);
                            }
                        })
                        .catch(err => console.error(err));
                    });
                });

                starContainer.addEventListener('mouseleave', () => {
                    renderStars(currentRating);
                    if(display) display.innerText = currentRating.toFixed(1);
                });
            }
        });
    </script>
}