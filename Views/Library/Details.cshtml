@using praca_dyplomowa_zesp.Models.Modules.Libraries.UserLibrary
@model GameInLibraryViewModel

@{
    ViewData["Title"] = Model.Name;
}

<style>
    /* Styl dla ikony osiągnięć */
    .achievement-icon {
        width: 64px;
        height: 64px;
        margin-right: 15px;
        transition: filter 0.3s ease;
    }

        .achievement-icon.locked {
            filter: grayscale(100%) opacity(0.6);
        }

        .achievement-icon.unlocked {
            filter: grayscale(0%);
        }

    /* Kursor rączki dla badge w labelu */
    .form-check-label .badge {
        cursor: pointer;
    }

    /* Styl dla pola notatek */
    #notes-area {
        resize: vertical;
        border: 1px solid #ced4da;
        background-color: #f8f9fa;
        transition: background-color 0.3s, border-color 0.3s;
    }

        #notes-area:focus {
            background-color: #fff;
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

    /* Status zapisu */
    #save-status {
        font-size: 0.85rem;
        transition: opacity 0.5s;
        opacity: 0;
    }
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function () {

        // --- Funkcja do przeliczania paska postępu w czasie rzeczywistym ---
        function recalculateProgress() {
            var total = $('.list-group-item').length; // Wszystkie osiągnięcia na liście
            if (total === 0) return;

            // Zliczamy, ile obrazków ma klasę 'unlocked'
            var unlocked = $('.achievement-icon.unlocked').length;

            var percent = Math.round((unlocked / total) * 100);

            var progressBar = $('#game-progress-bar');
            progressBar.css('width', percent + '%');
            progressBar.text(percent + '%');
            progressBar.attr('aria-valuenow', percent);
        }

        // --- Obsługa przełączania osiągnięć ---
        $('.achievement-checkbox').change(function () {
            var gameId = @Model.IgdbGameId;
            var achievementId = $(this).data('external-id');
            var isChecked = $(this).is(':checked');

            // Znajdź elementy powiązane z tym osiągnięciem
            var imgElement = $('#img-' + achievementId.replace(/[^a-zA-Z0-9]/g, '_'));
            var checkbox = $(this);

            $.ajax({
                url: '@Url.Action("ToggleAchievement", "Library")',
                type: 'POST',
                data: {
                    igdbGameId: gameId,
                    achievementExternalId: achievementId
                },
                headers: {
                    RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        // Znajdź label i badge wewnątrz niego
                        var label = $('label[for="' + checkbox.attr('id') + '"]');
                        var badge = label.find('.badge');

                        if (response.isUnlocked) {
                            // Wizualizacja: Odblokowane
                            imgElement.removeClass('locked').addClass('unlocked');
                            badge.removeClass('bg-secondary').addClass('bg-success');
                            badge.text("Odblokowane");
                        } else {
                            // Wizualizacja: Zablokowane
                            imgElement.removeClass('unlocked').addClass('locked');
                            badge.removeClass('bg-success').addClass('bg-secondary');
                            badge.text("Zablokowane");
                        }

                        // Przelicz pasek postępu natychmiast
                        recalculateProgress();

                    } else {
                        alert(response.error || 'Wystąpił błąd');
                        checkbox.prop('checked', !isChecked); // Cofnij zmianę
                    }
                },
                error: function () {
                    alert('Błąd komunikacji z serwerem.');
                    checkbox.prop('checked', !isChecked); // Cofnij zmianę
                }
            });
        });

        // --- Obsługa Notatek (Auto-zapis) ---
        // Zapisuje przy wyjściu z pola (blur)
        $('#notes-area').on('blur', function () {
            var notesContent = $(this).val();
            var gameId = @Model.DbId; // ID z tabeli GamesInLibraries
            var statusSpan = $('#save-status');

            statusSpan.text("Zapisywanie...").css('color', 'gray').css('opacity', 1);

            $.ajax({
                url: '@Url.Action("UpdateNotes", "Library")',
                type: 'POST',
                data: {
                    id: gameId,
                    notes: notesContent
                },
                headers: {
                    RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        statusSpan.text("Zapisano pomyślnie!").css('color', 'green');
                        // Ukryj komunikat po 2 sekundach
                        setTimeout(function () { statusSpan.css('opacity', 0); }, 2000);
                    } else {
                        statusSpan.text("Błąd zapisu.").css('color', 'red');
                    }
                },
                error: function () {
                    statusSpan.text("Błąd połączenia.").css('color', 'red');
                }
            });
        });
    });
</script>

<div class="row">
    <div class="col-md-4">
        <img src="@(Model.CoverUrl ?? "https://via.placeholder.com/264x352.png?text=Brak+okładki")" class="img-fluid rounded mb-3" alt="Okładka @Model.Name">

        <p class="mb-1">
            <strong>Postęp (%):</strong>
        </p>
        <div class="progress mb-3" style="height: 20px;">
            <div id="game-progress-bar" class="progress-bar bg-info" role="progressbar"
                 style="width: @Model.CurrentUserStoryProgressPercent%;"
                 aria-valuenow="@Model.CurrentUserStoryProgressPercent" aria-valuemin="0" aria-valuemax="100">
                @Model.CurrentUserStoryProgressPercent%
            </div>
        </div>

        <h4>Notatki</h4>
        <div class="form-group">
            <textarea id="notes-area" class="form-control" rows="10" placeholder="Wpisz swoje notatki tutaj...">@(Model.Notes)</textarea>
            <div class="mt-1" style="min-height: 20px;">
                <span id="save-status"></span>
            </div>
        </div>

    </div>

    <div class="col-md-8">
        <h1>@Model.Name</h1>
        <hr />

        <div class="mb-3">
            <a asp-controller="Guides" asp-action="Index" asp-route-gameId="@Model.IgdbGameId" class="btn btn-outline-info">
                Przejdź do Poradników i Wskazówek
            </a>
            <a asp-action="Delete" asp-route-id="@Model.DbId" class="btn btn-danger">Usuń z biblioteki</a>
        </div>


        <dl class="row">
            <dt class="col-sm-3">Deweloper</dt>
            <dd class="col-sm-9">@(Model.Developer ?? "Nieznany")</dd>

            <dt class="col-sm-3">Data wydania</dt>
            <dd class="col-sm-9">@(Model.ReleaseDate ?? "Nieznana")</dd>

            <dt class="col-sm-3">Data dodania</dt>
            <dd class="col-sm-9">@Model.DateAddedToLibrary.ToString("dd.MM.yyyy")</dd>

            <dt class="col-sm-3">Gatunki</dt>
            <dd class="col-sm-9">
                @if (Model.Genres != null && Model.Genres.Any())
                {
                    @string.Join(", ", Model.Genres)
                }
                else
                {
                    <span>Nieznane</span>
                }
            </dd>
        </dl>

        <hr />

        <h3>Osiągnięcia</h3>

        @if (Model.IsSteamGame && !Model.IsSteamConnected)
        {
            <div class="alert alert-warning d-flex align-items-center" role="alert">
                <i class="bi bi-steam me-2" style="font-size: 1.5rem;"></i>
                <div>
                    <strong>Chcesz automatycznie śledzić osiągnięcia?</strong><br />
                    Ta gra obsługuje osiągnięcia Steam. Połącz swoje konto, aby zaimportować postępy.
                    <br />
                    <a asp-controller="Profile" asp-action="Index" class="btn btn-sm btn-dark mt-2">
                        Połącz konto Steam w Profilu
                    </a>
                </div>
            </div>
        }

        @if (Model.Achievements != null && Model.Achievements.Any())
        {
            <form>
                @Html.AntiForgeryToken()
                <ul class="list-group">
                    @foreach (var ach in Model.Achievements)
                    {
                        var safeId = ach.ExternalId.Replace(" ", "_").Replace(".", "_");
                        var checkboxId = "ach-" + safeId;

                        // Sprawdzamy, czy to konkretne osiągnięcie pochodzi ze Steam (jest na liście zdobytych na Steamie)
                        bool isSteamUnlocked = Model.SteamUnlockedAchievementIds != null && Model.SteamUnlockedAchievementIds.Contains(ach.ExternalId);

                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <img src="@ach.IconUrl"
                                     alt="Ikona"
                                     id="img-@safeId"
                                     class="achievement-icon rounded @(ach.IsUnlocked ? "unlocked" : "locked")">
                                <div>
                                    <strong>@ach.Name</strong>
                                    <p class="mb-0 text-muted" style="font-size: 0.9rem;">@ach.Description</p>
                                </div>
                            </div>

                            @if (isSteamUnlocked)
                            {
                                @* Jeśli zdobyte na Steam -> Pokaż tylko info, brak możliwości zmiany *@
                                <span class="badge bg-success">Zdobyte (Steam)</span>
                            }
                            else
                            {
                                @* Jeśli NIE zdobyte na Steam -> Pozwól użytkownikowi przełączać *@
                                <div class="form-check form-switch">
                                    <input class="form-check-input achievement-checkbox"
                                           type="checkbox"
                                           role="switch"
                                           id="@checkboxId"
                                           data-external-id="@ach.ExternalId"
                                    @(ach.IsUnlocked ? "checked" : "")>
                                    <label class="form-check-label" for="@checkboxId">
                                        @* Badge, który wygląda jak ten ze Steam, ale jest klikalny (przez label) i zmienia się dynamicznie *@
                                        <span class="badge @(ach.IsUnlocked ? "bg-success" : "bg-secondary")">
                                            @(ach.IsUnlocked ? "Odblokowane" : "Zablokowane")
                                        </span>
                                    </label>
                                </div>
                            }
                        </li>
                    }
                </ul>
            </form>
        }
        else
        {
            <p>Brak dostępnych osiągnięć do śledzenia dla tej gry.</p>
        }
    </div>
</div>