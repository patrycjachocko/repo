@model List<praca_dyplomowa_zesp.Models.API.SteamGameDto>

@{
    ViewData["Title"] = "Biblioteka Steam";
}

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Twoja Biblioteka Steam <span class="text-muted" style="font-size: 0.6em;">(@Model.Count gier)</span></h2>

        <div class="d-flex gap-2">
            @if (Model.Any())
            {
                <form asp-action="ImportSteamGames" method="post" onsubmit="return confirm('To może chwilę potrwać. Czy na pewno chcesz zaimportować wszystkie gry, których nie masz w bibliotece?');">
                    <button type="submit" class="btn btn-success btn-sm">
                        <i class="bi bi-cloud-download"></i> Importuj wszystko do biblioteki
                    </button>
                </form>
            }
            <a asp-action="Index" class="btn btn-outline-secondary btn-sm">Powrót do profilu</a>
        </div>
    </div>

    @if (TempData["StatusMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["StatusMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <hr />

    @if (!Model.Any())
    {
        <div class="alert alert-warning">
            Nie znaleziono gier. Upewnij się, że Twój profil Steam jest publiczny.
        </div>
    }

    <div class="row">
        @foreach (var game in Model)
        {
            <div class="col-6 col-md-4 col-lg-3 col-xl-2 mb-4">
                <a asp-controller="Games" asp-action="SteamRedirect" asp-route-query="@game.Name" class="text-decoration-none text-dark">

                    <div class="card h-100 shadow-sm grow-on-hover" style="transition: transform 0.2s; border: none;">

                        <div style="position: relative; padding-top: 150%; overflow: hidden; background-color: #1b2838; border-radius: 5px;">
                            <img src="@($"https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/{game.AppId}/library_600x900.jpg")"
                                 class="card-img-top"
                                 style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;"
                                 alt="@game.Name"
                                 data-appid="@game.AppId"
                                 data-name="@game.Name"
                                 data-attempt="0"
                                 onerror="handleSteamImageError(this)">

                            <div class="loading-spinner" style="display:none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                <div class="spinner-border text-light" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>

                        <div class="card-body p-2">
                            <h6 class="card-title text-truncate font-weight-bold mt-2" title="@game.Name" style="margin-bottom: 0.2rem; font-size: 0.9rem;">
                                @game.Name
                            </h6>
                            <p class="card-text text-muted small">
                                @Math.Round(game.PlaytimeForever / 60.0, 1) h
                            </p>
                        </div>
                    </div>

                </a>
            </div>
        }
    </div>
</div>

<style>
    .grow-on-hover:hover {
        transform: scale(1.05);
        cursor: pointer;
        z-index: 10;
        box-shadow: 0 1rem 3rem rgba(0,0,0,.2) !important;
    }
</style>

<script>
    function handleSteamImageError(img) {
        const appId = img.getAttribute('data-appid');
        const name = img.getAttribute('data-name');
        let attempt = parseInt(img.getAttribute('data-attempt'));

        // Lista źródeł Steam do sprawdzenia
        const steamFallbacks = [
            `https://shared.akamai.steamstatic.com/store_item_assets/steam/apps/${appId}/header.jpg`,
            `https://steamcdn-a.akamaihd.net/steam/apps/${appId}/header.jpg`
        ];

        if (attempt < steamFallbacks.length) {
            // Próba kolejnego źródła ze Steam
            img.src = steamFallbacks[attempt];
            img.setAttribute('data-attempt', attempt + 1);
        } else if (attempt === steamFallbacks.length) {
            // OSTATNIA DESKA RATUNKU: IGDB (AJAX)
            // Zaznaczamy, że próbowaliśmy, żeby nie zapętlić
            img.setAttribute('data-attempt', attempt + 1);

            // Pokaż spinner (opcjonalnie, jeśli chcesz bajerów)
            // img.parentElement.querySelector('.loading-spinner').style.display = 'block';

            // Fetch do naszego backendu
            fetch(`/Profile/GetIgdbCover?steamId=${appId}&gameName=${encodeURIComponent(name)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.url) {
                        img.src = data.url;
                    } else {
                        // Jak IGDB też nie ma, to placeholder
                        img.src = 'https://via.placeholder.com/600x900?text=Brak+Grafiki';
                    }
                })
                .catch(err => {
                    console.error('Błąd pobierania z IGDB:', err);
                    img.src = 'https://via.placeholder.com/600x900?text=Brak+Grafiki';
                });
        } else {
            // Totalny koniec - placeholder
            img.onerror = null;
            img.src = 'https://via.placeholder.com/600x900?text=Brak+Grafiki';
        }
    }
</script>