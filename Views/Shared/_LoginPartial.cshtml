@using Microsoft.AspNetCore.Identity
@using praca_dyplomowa_zesp.Models.Users

@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager

<ul class="navbar-nav align-items-center">
    @if (SignInManager.IsSignedIn(User))
    {
        var user = await UserManager.GetUserAsync(User);

        @* --- SCENARIUSZ 1: UŻYTKOWNIK ISTNIEJE (WSZYSTKO OK) --- *@
        if (user != null)
        {
            var isAdmin = await UserManager.IsInRoleAsync(user, "Admin");
            var isMod = await UserManager.IsInRoleAsync(user, "Moderator");

            // Kolor ramki avatara
            string borderColor = "var(--neon-cyan)";
            if (isAdmin) { borderColor = "var(--neon-red)"; }
            else if (isMod) { borderColor = "var(--neon-green)"; }

            bool hasSteam = !string.IsNullOrEmpty(user.SteamId);

            @* --- PRZYCISK "POŁĄCZ STEAM" --- *@
            @if (!hasSteam)
            {
                <li class="nav-item me-3 d-none d-md-block">
                    <a asp-controller="Profile" asp-action="Index" class="btn btn-sm btn-secondary btn-static" title="Połącz Steam" style="padding: 5px 15px; font-size: 0.7rem;">
                        <i class="bi bi-steam"></i> POŁĄCZ
                    </a>
                </li>
            }

            @* --- DROPDOWN UŻYTKOWNIKA --- *@
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    @* AVATAR *@
                    <div style="position: relative;">
                        @if (user.ProfilePicture != null)
                        {
                            @* ZMIANA: Dodano v = DateTime.Now.Ticks, żeby wymusić odświeżenie *@
                            <img src="@Url.Action("GetAvatar", "Profile", new { id = user.Id, v = DateTime.Now.Ticks })" alt="Avatar"
                                 class="rounded-circle"
                                 style="width: 35px; height: 35px; object-fit: cover; border: 2px solid @borderColor; box-shadow: 0 0 10px @borderColor;" />
                        }
                        else
                        {
                            <img src="~/uploads/avatars/default_avatar.png" alt="Avatar"
                                 class="rounded-circle"
                                 style="width: 35px; height: 35px; object-fit: cover; border: 2px solid @borderColor; box-shadow: 0 0 10px @borderColor;" />
                        }
                    </div>
                    <span class="d-none d-sm-block text-uppercase" style="font-family: 'Rajdhani', sans-serif; font-weight: 700; letter-spacing: 1px;">
                        @user.UserName
                    </span>
                </a>

                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark" aria-labelledby="userDropdown">

                    @* HEADER *@
                    <li>
                        <div class="px-3 py-2">
                            <small class="text-muted d-block text-uppercase" style="font-size: 0.65rem; letter-spacing: 1px;">Zalogowano jako</small>
                            <span class="fw-bold text-white" style="font-family: 'Orbitron', sans-serif;">@user.UserName</span>
                        </div>
                    </li>
                    <li><hr class="dropdown-divider"></li>

                    @* --- SEKCJA ADMINA / MODA --- *@
                    @if (isAdmin)
                    {
                        <li>
                            <a class="dropdown-item item-neon-pink" asp-controller="Admin" asp-action="Index">
                                <i class="fas fa-user-shield me-2"></i> Panel Admina
                            </a>
                        </li>
                    }
                    @if (isMod)
                    {
                        <li>
                            <a class="dropdown-item item-neon-green" asp-controller="Admin" asp-action="Index">
                                <i class="fas fa-user-check me-2"></i> Panel Moderatora
                            </a>
                        </li>
                    }

                    @if (isAdmin || isMod)
                    {
                        <li><hr class="dropdown-divider"></li>
                    }

                    @* --- STANDARDOWE OPCJE --- *@
                    <li>
                        <a class="dropdown-item item-neon-cyan" asp-controller="Profile" asp-action="Index">
                            <i class="bi bi-person-circle me-2"></i> Mój Profil
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item item-neon-green" asp-controller="Library" asp-action="Index">
                            <i class="bi bi-collection-play me-2"></i> Moja Biblioteka
                        </a>
                    </li>

                    @if (hasSteam)
                    {
                        <li>
                            <a class="dropdown-item item-neon-purple" asp-controller="Profile" asp-action="SteamLibrary">
                                <i class="bi bi-steam me-2"></i> Biblioteka Steam
                            </a>
                        </li>
                    }

                    <li><hr class="dropdown-divider"></li>

                    <li>
                        <a class="dropdown-item item-neon-yellow" asp-controller="Tickets" asp-action="Index">
                            <i class="fas fa-headset me-2"></i> Zgłoś problem
                        </a>
                    </li>

                    <li><hr class="dropdown-divider"></li>

                    @* WYLOGUJ *@
                    <li>
                        <form class="form-inline" asp-controller="Account" asp-action="Logout" asp-route-returnUrl="@Context.Request.Path@Context.Request.QueryString">
                            <button type="submit" class="dropdown-item item-neon-red fw-bold">
                                <i class="bi bi-box-arrow-right me-2"></i> WYLOGUJ
                            </button>
                        </form>
                    </li>
                </ul>
            </li>
        }
        else
        {
            @* --- SCENARIUSZ 2: GHOST USER (CIASTECZKO JEST, ALE USER NIE ISTNIEJE W BAZIE) --- *@
            <li class="nav-item">
                <form class="form-inline" asp-controller="Account" asp-action="Logout" asp-route-returnUrl="@Context.Request.Path@Context.Request.QueryString">
                    <button type="submit" class="btn btn-sm btn-danger fw-bold" style="box-shadow: 0 0 15px red; animation: pulse 1.5s infinite;">
                        <i class="fas fa-exclamation-triangle me-1"></i> NAPRAW BŁĄD SESJI
                    </button>
                </form>
            </li>
        }
    }
    else
    {
        @* --- SCENARIUSZ 3: NIEZALOGOWANY --- *@
        <li class="nav-item">
            <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal">
                ZALOGUJ
            </a>
        </li>
        <li class="nav-item ms-2">
            <a class="btn btn-sm btn-primary" href="#" data-bs-toggle="modal" data-bs-target="#registerModal" style="padding: 6px 20px;">
                <i class="bi bi-person-plus me-1"></i> REJESTRACJA
            </a>
        </li>
    }
</ul>